<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Marcas e Lojas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container">
        <header>
            <h1>Relatórios de Marcas e Lojas</h1>
            <p>Gere relatórios detalhados por período e marca</p>
        </header>

        <div class="filters-container">
            <form id="reportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Data Inicial</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">Data Final</label>
                        <input type="date" id="endDate" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="marca">Marca</label>
                        <select id="marca" name="marca">
                            <option value="">Todas as Marcas</option>
                            <!-- As opções serão preenchidas via JavaScript -->
                        </select>
                    </div>
                </div>
                
                <div class="btn-container">
                    <button type="submit" class="btn-generate">Gerar Relatório</button>
                </div>
            </form>
        </div>

        <div class="summary-cards" id="summaryCards" class="hidden">
            <!-- Cards de resumo serão inseridos aqui via JavaScript -->
        </div>

        <div class="reports-container">
            <div class="reports-header">
                <span>Relatório Detalhado</span>
                <div class="export-buttons" id="exportButtons" class="hidden">
                    <button class="btn-export" id="exportExcel">Exportar para Excel</button>
                    <button class="btn-export" id="exportPDF">Exportar para PDF</button>
                    <button class="btn-print" id="printReport">Imprimir Relatório</button>
                </div>
            </div>
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>MARCA</th>
                        <th>LOJA</th>
                        <th>DATA</th>
                        <th>VALOR 20L</th>
                        <th>VALOR 10L</th>
                        <th>VALOR 1500ML</th>
                        <th>VALOR CX COPO</th>
                        <th>VALOR VASILHAME</th>
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <!-- Dados serão inseridos aqui via JavaScript -->
                </tbody>
            </table>
            <div id="emptyReportMessage" class="empty-message">
                Nenhum relatório gerado. Use os filtros acima para gerar um relatório.
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reportForm = document.getElementById('reportForm');
            const reportsTableBody = document.getElementById('reportsTableBody');
            const emptyReportMessage = document.getElementById('emptyReportMessage');
            const exportButtons = document.getElementById('exportButtons');
            const summaryCards = document.getElementById('summaryCards');
            const marcaSelect = document.getElementById('marca');
            const exportExcelBtn = document.getElementById('exportExcel');
            const exportPDFBtn = document.getElementById('exportPDF');
            const printReportBtn = document.getElementById('printReport');
            
            // Definir datas padrão (últimos 30 dias)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            // Carregar marcas do localStorage
            loadBrands();
            
            // Função para carregar as marcas do localStorage
            function loadBrands() {
                const brands = JSON.parse(localStorage.getItem('brands')) || [];
                marcaSelect.innerHTML = '<option value="">Todas as Marcas</option>';
                
                brands.forEach((brand, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = brand.marca;
                    marcaSelect.appendChild(option);
                });
            }
            
            // Gerar dados de exemplo se não existirem
            function generateSampleData() {
                const sampleData = JSON.parse(localStorage.getItem('reportData'));
                
                if (!sampleData || sampleData.length === 0) {
                    const brands = JSON.parse(localStorage.getItem('brands')) || [];
                    const stores = JSON.parse(localStorage.getItem('stores')) || [];
                    
                    if (brands.length === 0 || stores.length === 0) {
                        alert('É necessário cadastrar marcas e lojas primeiro para gerar relatórios.');
                        return [];
                    }
                    
                    // Gerar dados de exemplo
                    const data = [];
                    const today = new Date();
                    
                    for (let i = 0; i < 100; i++) {
                        const randomBrandIndex = Math.floor(Math.random() * brands.length);
                        const brandStores = stores.filter(store => store.marca_id == randomBrandIndex);
                        
                        if (brandStores.length === 0) continue;
                        
                        const randomStoreIndex = Math.floor(Math.random() * brandStores.length);
                        const store = brandStores[randomStoreIndex];
                        
                        const randomDate = new Date();
                        randomDate.setDate(today.getDate() - Math.floor(Math.random() * 90));
                        
                        data.push({
                            marca: brands[randomBrandIndex].marca,
                            loja: store.loja,
                            data: randomDate.toISOString().split('T')[0],
                            valor_20l: (Math.random() * 100).toFixed(2),
                            valor_10l: (Math.random() * 80).toFixed(2),
                            valor_1500ml: (Math.random() * 50).toFixed(2),
                            valor_cx_copo: (Math.random() * 120).toFixed(2),
                            valor_vasilhame: (Math.random() * 30).toFixed(2)
                        });
                    }
                    
                    localStorage.setItem('reportData', JSON.stringify(data));
                    return data;
                }
                
                return sampleData;
            }
            
            // Função para gerar o relatório
            function generateReport(startDate, endDate, marcaId) {
                const reportData = generateSampleData();
                
                if (reportData.length === 0) {
                    return [];
                }
                
                // Filtrar dados por data e marca
                const filteredData = reportData.filter(item => {
                    const itemDate = new Date(item.data);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    // Verificar se a data está dentro do intervalo
                    const dateInRange = itemDate >= start && itemDate <= end;
                    
                    // Verificar se a marca corresponde
                    let marcaMatches = true;
                    if (marcaId !== "") {
                        const brands = JSON.parse(localStorage.getItem('brands')) || [];
                        const selectedBrand = brands[parseInt(marcaId)];
                        marcaMatches = selectedBrand && item.marca === selectedBrand.marca;
                    }
                    
                    return dateInRange && marcaMatches;
                });
                
                return filteredData;
            }
            
            // Função para atualizar a tabela de relatórios
            function updateReportsTable(data) {
                reportsTableBody.innerHTML = '';
                
                if (data.length === 0) {
                    emptyReportMessage.style.display = 'block';
                    exportButtons.style.display = 'none';
                    summaryCards.style.display = 'none';
                    return;
                }
                
                emptyReportMessage.style.display = 'none';
                exportButtons.style.display = 'flex';
                summaryCards.style.display = 'flex';
                
                // Calcular totais
                let total20L = 0;
                let total10L = 0;
                let total1500ml = 0;
                let totalCxCopo = 0;
                let totalVasilhame = 0;
                let grandTotal = 0;
                
                // Agrupar por marca para exibir totais
                const brandsData = {};
                
                data.forEach(item => {
                    if (!brandsData[item.marca]) {
                        brandsData[item.marca] = {
                            items: [],
                            total20L: 0,
                            total10L: 0,
                            total1500ml: 0,
                            totalCxCopo: 0,
                            totalVasilhame: 0,
                            total: 0
                        };
                    }
                    
                    const itemTotal = parseFloat(item.valor_20l) + parseFloat(item.valor_10l) + 
                                     parseFloat(item.valor_1500ml) + parseFloat(item.valor_cx_copo) + 
                                     parseFloat(item.valor_vasilhame);
                    
                    brandsData[item.marca].items.push({
                        ...item,
                        total: itemTotal
                    });
                    
                    brandsData[item.marca].total20L += parseFloat(item.valor_20l);
                    brandsData[item.marca].total10L += parseFloat(item.valor_10l);
                    brandsData[item.marca].total1500ml += parseFloat(item.valor_1500ml);
                    brandsData[item.marca].totalCxCopo += parseFloat(item.valor_cx_copo);
                    brandsData[item.marca].totalVasilhame += parseFloat(item.valor_vasilhame);
                    brandsData[item.marca].total += itemTotal;
                    
                    total20L += parseFloat(item.valor_20l);
                    total10L += parseFloat(item.valor_10l);
                    total1500ml += parseFloat(item.valor_1500ml);
                    totalCxCopo += parseFloat(item.valor_cx_copo);
                    totalVasilhame += parseFloat(item.valor_vasilhame);
                    grandTotal += itemTotal;
                });
                
                // Formatar valores monetários
                const formatCurrency = (value) => {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };
                
                // Preencher a tabela
                Object.keys(brandsData).forEach(marca => {
                    const brandData = brandsData[marca];
                    
                    // Cabeçalho da marca
                    const brandHeader = document.createElement('tr');
                    brandHeader.className = 'brand-header';
                    brandHeader.innerHTML = `
                        <td colspan="9">${marca}</td>
                    `;
                    reportsTableBody.appendChild(brandHeader);
                    
                    // Itens da marca
                    brandData.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td></td>
                            <td>${item.loja}</td>
                            <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
                            <td class="currency-value">${formatCurrency(parseFloat(item.valor_20l))}</td>
                            <td class="currency-value">${formatCurrency(parseFloat(item.valor_10l))}</td>
                            <td class="currency-value">${formatCurrency(parseFloat(item.valor_1500ml))}</td>
                            <td class="currency-value">${formatCurrency(parseFloat(item.valor_cx_copo))}</td>
                            <td class="currency-value">${formatCurrency(parseFloat(item.valor_vasilhame))}</td>
                            <td class="currency-value">${formatCurrency(item.total)}</td>
                        `;
                        reportsTableBody.appendChild(row);
                    });
                    
                    // Total da marca
                    const brandTotal = document.createElement('tr');
                    brandTotal.className = 'brand-total';
                    brandTotal.innerHTML = `
                        <td colspan="3">Total ${marca}</td>
                        <td class="currency-value">${formatCurrency(brandData.total20L)}</td>
                        <td class="currency-value">${formatCurrency(brandData.total10L)}</td>
                        <td class="currency-value">${formatCurrency(brandData.total1500ml)}</td>
                        <td class="currency-value">${formatCurrency(brandData.totalCxCopo)}</td>
                        <td class="currency-value">${formatCurrency(brandData.totalVasilhame)}</td>
                        <td class="currency-value">${formatCurrency(brandData.total)}</td>
                    `;
                    reportsTableBody.appendChild(brandTotal);
                });
                
                // Atualizar cards de resumo
                updateSummaryCards(data.length, grandTotal, total20L, total10L);
            }
            
            // Função para atualizar os cards de resumo
            function updateSummaryCards(totalItems, grandTotal, total20L, total10L) {
                summaryCards.innerHTML = `
                    <div class="summary-card">
                        <h3>Total de Registros</h3>
                        <div class="value">${totalItems}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Valor Total</h3>
                        <div class="value">${new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(grandTotal)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Média por Registro</h3>
                        <div class="value">${new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(grandTotal / totalItems)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Produto Mais Vendido</h3>
                        <div class="value">${total20L > total10L ? '20L' : '10L'}</div>
                    </div>
                `;
            }
            
            // Evento de envio do formulário
            reportForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const marcaId = document.getElementById('marca').value;
                
                if (!startDate || !endDate) {
                    alert('Por favor, selecione as datas inicial e final.');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('A data inicial não pode ser maior que a data final.');
                    return;
                }
                
                const reportData = generateReport(startDate, endDate, marcaId);
                updateReportsTable(reportData);
            });
            
            // Função para exportar para Excel
            exportExcelBtn.addEventListener('click', function() {
                alert('Funcionalidade de exportação para Excel seria implementada aqui.');
                // Em uma implementação real, você usaria uma biblioteca como SheetJS
            });
            
            // Função para exportar para PDF
            exportPDFBtn.addEventListener('click', function() {
                alert('Funcionalidade de exportação para PDF seria implementada aqui.');
                // Em uma implementação real, você usaria uma biblioteca como jsPDF
            });
            
            // Função para imprimir
            printReportBtn.addEventListener('click', function() {
                window.print();
            });
        });
    </script>
  </main>
</body>
</html>
