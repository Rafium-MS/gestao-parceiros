<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Marcas e Lojas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container">
        <header>
            <h1>Relatórios de Marcas e Lojas</h1>
            <p>Gere relatórios detalhados por período e marca</p>
        </header>

        <div class="filters-container">
            <form id="reportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Data Inicial</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">Data Final</label>
                        <input type="date" id="endDate" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="marca">Marca</label>
                        <select id="marca" name="marca">
                            <option value="">Todas as Marcas</option>
                            <!-- As opções serão preenchidas via JavaScript -->
                        </select>
                    </div>
                </div>
                
                <div class="btn-container">
                    <button type="submit" class="btn-generate">Gerar Relatório</button>
                </div>
            </form>
        </div>

        <div class="summary-cards" id="summaryCards" class="hidden">
            <!-- Cards de resumo serão inseridos aqui via JavaScript -->
        </div>

        <div class="reports-container">
            <div class="reports-header">
                <span>Relatório Detalhado</span>
                <div class="export-buttons" id="exportButtons" class="hidden">
                    <button class="btn-export" id="exportExcel">Exportar para Excel</button>
                    <button class="btn-export" id="exportPDF">Exportar para PDF</button>
                    <button class="btn-print" id="printReport">Imprimir Relatório</button>
                </div>
            </div>
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>MARCA</th>
                        <th>LOJA</th>
                        <th>DATA</th>
                        <th>VALOR 20L</th>
                        <th>VALOR 10L</th>
                        <th>VALOR 1500ML</th>
                        <th>VALOR CX COPO</th>
                        <th>VALOR VASILHAME</th>
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <!-- Dados serão inseridos aqui via JavaScript -->
                </tbody>
            </table>
            <div id="emptyReportMessage" class="empty-message">
                Nenhum relatório gerado. Use os filtros acima para gerar um relatório.
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const reportForm = document.getElementById('reportForm');
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const marcaSelect = document.getElementById('marca');
            const reportsTableBody = document.getElementById('reportsTableBody');
            const emptyReportMessage = document.getElementById('emptyReportMessage');
            const exportButtons = document.getElementById('exportButtons');
            const summaryCards = document.getElementById('summaryCards');
            const exportExcelBtn = document.getElementById('exportExcel');
            const exportPDFBtn = document.getElementById('exportPDF');
            const printReportBtn = document.getElementById('printReport');

            const state = {
                lastFilters: null,
                lastData: []
            };

            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            startInput.valueAsDate = thirtyDaysAgo;
            endInput.valueAsDate = today;

            loadBrands();

            reportForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const startDate = startInput.value;
                const endDate = endInput.value;
                const marca = marcaSelect.value;

                if (!startDate || !endDate) {
                    alert('Por favor, selecione as datas inicial e final.');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    alert('A data inicial não pode ser maior que a data final.');
                    return;
                }

                try {
                    const data = await fetchReportData(startDate, endDate, marca);
                    state.lastFilters = { startDate, endDate, marca };
                    state.lastData = data;
                    updateReportsTable(data);
                } catch (error) {
                    console.error(error);
                    alert(error.message || 'Não foi possível gerar o relatório. Tente novamente mais tarde.');
                }
            });

            exportExcelBtn.addEventListener('click', () => triggerExport('excel'));
            exportPDFBtn.addEventListener('click', () => triggerExport('pdf'));
            printReportBtn.addEventListener('click', () => window.print());

            async function loadBrands() {
                try {
                    const response = await fetch('/api/brands');
                    if (!response.ok) {
                        throw new Error('Não foi possível carregar as marcas.');
                    }

                    const brands = await response.json();
                    marcaSelect.innerHTML = '<option value="">Todas as Marcas</option>';

                    brands.forEach((brand) => {
                        const option = document.createElement('option');
                        option.value = brand.marca;
                        option.textContent = brand.marca;
                        marcaSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error(error);
                    marcaSelect.innerHTML = '<option value="">Todas as Marcas</option>';
                    alert(error.message || 'Não foi possível carregar as marcas.');
                }
            }

            async function fetchReportData(startDate, endDate, marca) {
                const params = new URLSearchParams({ startDate, endDate });
                if (marca) {
                    params.set('marca', marca);
                }

                const response = await fetch(`/api/report-data?${params.toString()}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Nenhum dado encontrado para os filtros selecionados.');
                    }
                    throw new Error('Não foi possível gerar o relatório.');
                }

                return await response.json();
            }

            function updateReportsTable(data) {
                reportsTableBody.innerHTML = '';

                if (!data || data.length === 0) {
                    emptyReportMessage.style.display = 'block';
                    exportButtons.style.display = 'none';
                    summaryCards.style.display = 'none';
                    return;
                }

                emptyReportMessage.style.display = 'none';
                exportButtons.style.display = 'flex';
                summaryCards.style.display = 'flex';

                const totals = {
                    registros: data.length,
                    valor20: 0,
                    valor10: 0,
                    valor1500: 0,
                    valorCxCopo: 0,
                    valorVasilhame: 0,
                    valorTotal: 0,
                    porMarca: {}
                };

                const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);

                data.forEach((item) => {
                    const marca = item.marca;
                    const valor20 = toNumber(item.valor_20l);
                    const valor10 = toNumber(item.valor_10l);
                    const valor1500 = toNumber(item.valor_1500ml);
                    const valorCxCopo = toNumber(item.valor_cx_copo);
                    const valorVasilhame = toNumber(item.valor_vasilhame);
                    const totalLinha = valor20 + valor10 + valor1500 + valorCxCopo + valorVasilhame;

                    if (!totals.porMarca[marca]) {
                        totals.porMarca[marca] = {
                            items: [],
                            valor20: 0,
                            valor10: 0,
                            valor1500: 0,
                            valorCxCopo: 0,
                            valorVasilhame: 0,
                            valorTotal: 0
                        };
                    }

                    totals.porMarca[marca].items.push({
                        ...item,
                        total: totalLinha
                    });

                    totals.porMarca[marca].valor20 += valor20;
                    totals.porMarca[marca].valor10 += valor10;
                    totals.porMarca[marca].valor1500 += valor1500;
                    totals.porMarca[marca].valorCxCopo += valorCxCopo;
                    totals.porMarca[marca].valorVasilhame += valorVasilhame;
                    totals.porMarca[marca].valorTotal += totalLinha;

                    totals.valor20 += valor20;
                    totals.valor10 += valor10;
                    totals.valor1500 += valor1500;
                    totals.valorCxCopo += valorCxCopo;
                    totals.valorVasilhame += valorVasilhame;
                    totals.valorTotal += totalLinha;
                });

                Object.keys(totals.porMarca).forEach((marca) => {
                    const marcaData = totals.porMarca[marca];

                    const brandHeader = document.createElement('tr');
                    brandHeader.className = 'brand-header';
                    brandHeader.innerHTML = `<td colspan="9">${marca}</td>`;
                    reportsTableBody.appendChild(brandHeader);

                    marcaData.items.forEach((item) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td></td>
                            <td>${item.loja}</td>
                            <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
                            <td class="currency-value">${formatCurrency(toNumber(item.valor_20l))}</td>
                            <td class="currency-value">${formatCurrency(toNumber(item.valor_10l))}</td>
                            <td class="currency-value">${formatCurrency(toNumber(item.valor_1500ml))}</td>
                            <td class="currency-value">${formatCurrency(toNumber(item.valor_cx_copo))}</td>
                            <td class="currency-value">${formatCurrency(toNumber(item.valor_vasilhame))}</td>
                            <td class="currency-value">${formatCurrency(item.total)}</td>
                        `;
                        reportsTableBody.appendChild(row);
                    });

                    const totalsRow = document.createElement('tr');
                    totalsRow.className = 'brand-total';
                    totalsRow.innerHTML = `
                        <td colspan="3">Total ${marca}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valor20)}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valor10)}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valor1500)}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valorCxCopo)}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valorVasilhame)}</td>
                        <td class="currency-value">${formatCurrency(marcaData.valorTotal)}</td>
                    `;
                    reportsTableBody.appendChild(totalsRow);
                });

                updateSummaryCards(totals);
            }

            function toNumber(value) {
                const number = Number(value);
                return Number.isFinite(number) ? number : 0;
            }

            function updateSummaryCards(totals) {
                const media = totals.registros > 0 ? totals.valorTotal / totals.registros : 0;
                let produtoMaisVendido = 'N/A';
                if (totals.valor20 > 0 || totals.valor10 > 0) {
                    produtoMaisVendido = totals.valor20 >= totals.valor10 ? '20L' : '10L';
                }

                summaryCards.innerHTML = `
                    <div class="summary-card">
                        <h3>Total de Registros</h3>
                        <div class="value">${totals.registros}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Valor Total</h3>
                        <div class="value">${new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(totals.valorTotal)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Média por Registro</h3>
                        <div class="value">${new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(media)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Produto Mais Vendido</h3>
                        <div class="value">${produtoMaisVendido}</div>
                    </div>
                `;
            }

            async function triggerExport(format) {
                if (!state.lastFilters) {
                    alert('Gere um relatório antes de exportar.');
                    return;
                }

                const params = new URLSearchParams({
                    format,
                    startDate: state.lastFilters.startDate,
                    endDate: state.lastFilters.endDate
                });

                if (state.lastFilters.marca) {
                    params.set('marca', state.lastFilters.marca);
                }

                try {
                    const response = await fetch(`/api/report-data/export?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('Não foi possível exportar o relatório.');
                    }

                    const blob = await response.blob();
                    const downloadName = getFilenameFromDisposition(response.headers.get('Content-Disposition'))
                        || (format === 'excel' ? 'relatorio.xlsx' : 'relatorio.pdf');

                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = downloadName;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error(error);
                    alert(error.message || 'Não foi possível exportar o relatório. Tente novamente mais tarde.');
                }
            }

            function getFilenameFromDisposition(disposition) {
                if (!disposition) {
                    return null;
                }

                const match = disposition.match(/filename="?([^";]+)"?/i);
                return match ? match[1] : null;
            }
        });
    </script>
  </main>
</body>
</html>
