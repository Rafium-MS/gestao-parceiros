<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importa√ß√£o de Imagens</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container">
        <header>
            <h1>Importa√ß√£o de Imagens</h1>
            <p>Processo de importa√ß√£o com etapas de verifica√ß√£o</p>
        </header>

        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-bar" id="progressBar"></div>
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Sele√ß√£o</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Verifica√ß√£o</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-text">Configura√ß√£o</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-text">Conclus√£o</div>
                </div>
            </div>
        </div>

        <!-- Etapa 1: Sele√ß√£o de Imagens -->
        <div class="step-content active" id="stepContent1">
            <h2>Sele√ß√£o de Imagens</h2>
            <p>Selecione as imagens que deseja importar para o sistema.</p>
            
            <div class="form-group">
                <label for="marca">Associar a Marca</label>
                <select id="marca" name="marca" required>
                    <option value="">Selecione uma marca</option>
                    <!-- As op√ß√µes ser√£o preenchidas via JavaScript -->
                </select>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Arraste e solte as imagens aqui</h3>
                <p>ou</p>
                <button type="button" class="btn btn-next" id="browseFiles">Procurar Arquivos</button>
                <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
            </div>
            
            <div class="preview-container" id="previewContainer">
                <!-- As pr√©-visualiza√ß√µes das imagens ser√£o inseridas aqui -->
            </div>
            
            <div class="btn-container">
                <div></div> <!-- Espa√ßo vazio para alinhamento -->
                <button type="button" class="btn btn-next" id="toStep2">Continuar para Verifica√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 2: Verifica√ß√£o -->
        <div class="step-content" id="stepContent2">
            <h2>Verifica√ß√£o de Imagens</h2>
            <p>Verificando as imagens selecionadas para garantir compatibilidade.</p>
            
            <div class="verification-results" id="verificationResults">
                <!-- Os resultados da verifica√ß√£o ser√£o inseridos aqui -->
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn btn-prev" id="toStep1">Voltar</button>
                <button type="button" class="btn btn-next" id="toStep3">Continuar para Configura√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 3: Configura√ß√£o -->
        <div class="step-content" id="stepContent3">
            <h2>Configura√ß√£o de Importa√ß√£o</h2>
            <p>Defina as op√ß√µes para a importa√ß√£o das imagens.</p>
            
            <div class="form-group">
                <label for="imageQuality">Qualidade da Imagem</label>
                <select id="imageQuality" name="imageQuality">
                    <option value="high">Alta (Melhor qualidade, maior tamanho)</option>
                    <option value="medium" selected>M√©dia (Balan√ßo entre qualidade e tamanho)</option>
                    <option value="low">Baixa (Menor qualidade, tamanho reduzido)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="imageSize">Redimensionar Imagens</label>
                <select id="imageSize" name="imageSize">
                    <option value="original">Manter tamanho original</option>
                    <option value="large">Grande (1920x1080px)</option>
                    <option value="medium" selected>M√©dio (1280x720px)</option>
                    <option value="small">Pequeno (800x600px)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="namingConvention">Conven√ß√£o de Nomes</label>
                <select id="namingConvention" name="namingConvention">
                    <option value="original">Manter nomes originais</option>
                    <option value="timestamp">Usar timestamp</option>
                    <option value="sequential" selected>Sequencial (imagem_001, imagem_002...)</option>
                </select>
            </div>
            
            <div class="summary-container">
                <h3>Resumo da Importa√ß√£o</h3>
                <div class="summary-item">
                    <span class="summary-label">Total de Imagens:</span>
                    <span class="summary-value" id="summaryCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tamanho Total:</span>
                    <span class="summary-value" id="summarySize">0 MB</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Marca Associada:</span>
                    <span class="summary-value" id="summaryBrand">Nenhuma</span>
                </div>
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn btn-prev" id="toStep2">Voltar</button>
                <button type="button" class="btn btn-submit" id="startImport">Iniciar Importa√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 4: Conclus√£o -->
        <div class="step-content" id="stepContent4">
            <h2>Importa√ß√£o Conclu√≠da</h2>
            
            <div id="successMessage" class="alert alert-success hidden">
                <strong>Sucesso!</strong> <span id="successMessageText">Todas as imagens foram importadas com sucesso.</span>
            </div>

            <div id="errorMessage" class="alert alert-error hidden">
                <strong>Erro!</strong> <span id="errorMessageText">Ocorreu um problema durante a importa√ß√£o.</span>
            </div>
            
            <div class="summary-container">
                <h3>Resultado da Importa√ß√£o</h3>
                <div class="summary-item">
                    <span class="summary-label">Imagens Importadas:</span>
                    <span class="summary-value" id="importedCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Imagens com Erro:</span>
                    <span class="summary-value" id="errorCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tempo de Processamento:</span>
                    <span class="summary-value" id="processingTime">0 segundos</span>
                </div>
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn btn-prev" id="toStep1">Importar Mais Imagens</button>
                <button type="button" class="btn btn-next" id="viewImages">Visualizar Imagens</button>
            </div>
        </div>

        <section class="form-container">
            <h2 class="section-title">Comprovantes cadastrados</h2>
            <div class="table-wrapper">
                <table class="table-compact" id="receiptsTable">
                    <thead>
                        <tr>
                            <th>Arquivo</th>
                            <th>Marca</th>
                            <th>Tamanho</th>
                            <th>Enviado em</th>
                            <th class="column-actions">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="receiptsTableBody"></tbody>
                </table>
            </div>
            <p id="receiptsEmptyMessage" class="empty-message">Nenhum comprovante cadastrado.</p>
        </section>

        <section class="form-container hidden" id="receiptEditContainer">
            <h3 class="section-title">Editar comprovante</h3>
            <form id="receiptEditForm">
                <input type="hidden" id="editReceiptId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFilename">Nome do arquivo</label>
                        <input type="text" id="editFilename" required>
                    </div>
                    <div class="form-group">
                        <label for="editReceiptBrand">Marca associada</label>
                        <select id="editReceiptBrand">
                            <option value="">Sem marca</option>
                        </select>
                    </div>
                </div>
                <div class="btn-container">
                    <button type="submit" class="btn btn-submit">Salvar altera√ß√µes</button>
                    <button type="button" class="btn btn-reset" id="cancelReceiptEdit">Cancelar</button>
                </div>
                <div id="receiptEditMessage" class="form-message" role="status" aria-live="polite"></div>
            </form>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            const progressBar = document.getElementById('progressBar');
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseFilesBtn = document.getElementById('browseFiles');
            const previewContainer = document.getElementById('previewContainer');
            const verificationResults = document.getElementById('verificationResults');
            const marcaSelect = document.getElementById('marca');

            const toStep2Btn = document.getElementById('toStep2');
            const toStep1From2Btn = document.querySelector('#stepContent2 #toStep1');
            const toStep3Btn = document.getElementById('toStep3');
            const toStep2From3Btn = document.querySelector('#stepContent3 #toStep2');
            const startImportBtn = document.getElementById('startImport');
            const toStep1From4Btn = document.querySelector('#stepContent4 #toStep1');
            const viewImagesBtn = document.getElementById('viewImages');

            const summaryCount = document.getElementById('summaryCount');
            const summarySize = document.getElementById('summarySize');
            const summaryBrand = document.getElementById('summaryBrand');

            const importedCount = document.getElementById('importedCount');
            const errorCount = document.getElementById('errorCount');
            const processingTime = document.getElementById('processingTime');

            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const successMessageText = document.getElementById('successMessageText');
            const errorMessageText = document.getElementById('errorMessageText');

            const receiptsTableBody = document.getElementById('receiptsTableBody');
            const receiptsEmptyMessage = document.getElementById('receiptsEmptyMessage');

            const receiptEditContainer = document.getElementById('receiptEditContainer');
            const receiptEditForm = document.getElementById('receiptEditForm');
            const editReceiptId = document.getElementById('editReceiptId');
            const editFilename = document.getElementById('editFilename');
            const editReceiptBrand = document.getElementById('editReceiptBrand');
            const cancelReceiptEditBtn = document.getElementById('cancelReceiptEdit');
            const receiptEditMessage = document.getElementById('receiptEditMessage');

            let currentStep = 1;
            let selectedFiles = [];
            let brands = [];
            let receipts = [];
            let editingReceiptId = null;

            loadBrands();
            loadReceipts();
            updateSummary();

            browseFilesBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            uploadArea.addEventListener('dragover', (event) => {
                event.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (event) => {
                event.preventDefault();
                uploadArea.classList.remove('dragover');
                if (event.dataTransfer.files.length) {
                    handleFiles(event.dataTransfer.files);
                }
            });

            toStep2Btn.addEventListener('click', () => goToStep(2));
            toStep1From2Btn.addEventListener('click', () => goToStep(1));
            toStep3Btn.addEventListener('click', () => goToStep(3));
            toStep2From3Btn.addEventListener('click', () => goToStep(2));
            startImportBtn.addEventListener('click', () => goToStep(4));
            toStep1From4Btn.addEventListener('click', () => {
                selectedFiles = [];
                previewContainer.innerHTML = '';
                updateSummary();
                successMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');
                goToStep(1);
            });

            viewImagesBtn.addEventListener('click', () => {
                document.getElementById('receiptsTable').scrollIntoView({ behavior: 'smooth' });
            });

            marcaSelect.addEventListener('change', updateSummary);

            receiptsTableBody.addEventListener('click', (event) => {
                const editBtn = event.target.closest('.btn-edit-receipt');
                if (editBtn) {
                    const receiptId = Number.parseInt(editBtn.dataset.id, 10);
                    if (!Number.isNaN(receiptId)) {
                        startReceiptEdit(receiptId);
                    }
                }
            });

            receiptEditForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!editingReceiptId) {
                    return;
                }
                const payload = {
                    filename: editFilename.value.trim(),
                    brand_id: editReceiptBrand.value ? Number(editReceiptBrand.value) : null,
                };
                if (!payload.filename) {
                    displayEditMessage('Informe um nome v√°lido para o arquivo.', 'error');
                    return;
                }
                try {
                    const response = await fetch(`/api/receipts/${editingReceiptId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.error || 'N√£o foi poss√≠vel atualizar o comprovante.');
                    }
                    displayEditMessage('Comprovante atualizado com sucesso.', 'success');
                    await loadReceipts();
                    const updated = receipts.find((item) => item.id === editingReceiptId);
                    if (updated) {
                        editFilename.value = updated.filename;
                        editReceiptBrand.value = updated.brand_id ? String(updated.brand_id) : '';
                    }
                } catch (error) {
                    displayEditMessage(error.message, 'error');
                }
            });

            cancelReceiptEditBtn.addEventListener('click', () => {
                closeReceiptEditor();
            });

            function handleFileSelect(event) {
                handleFiles(event.target.files);
                fileInput.value = '';
            }

            function handleFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    if (!file.type.match('image.*')) {
                        alert(`O arquivo "${file.name}" n√£o √© uma imagem. Apenas arquivos de imagem s√£o permitidos.`);
                        continue;
                    }

                    if (selectedFiles.some((f) => f.name === file.name && f.size === file.size)) {
                        continue;
                    }

                    selectedFiles.push(file);
                    createPreview(file);
                }

                updateSummary();
            }

            function createPreview(file) {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);

                    previewItem.innerHTML = `
                        <img src="${event.target.result}" class="preview-image" alt="${file.name}">
                        <div class="preview-info">
                            <div class="preview-name">${file.name}</div>
                            <div class="preview-size">${fileSize} MB</div>
                        </div>
                        <button class="preview-remove" data-filename="${file.name}">√ó</button>
                    `;

                    previewContainer.appendChild(previewItem);

                    const removeBtn = previewItem.querySelector('.preview-remove');
                    removeBtn.addEventListener('click', function() {
                        const filename = this.getAttribute('data-filename');
                        selectedFiles = selectedFiles.filter((f) => f.name !== filename);
                        previewContainer.removeChild(previewItem);
                        updateSummary();
                    });
                };

                reader.readAsDataURL(file);
            }

            function updateSummary() {
                const totalSize = selectedFiles.reduce((total, file) => total + file.size, 0);
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);

                summaryCount.textContent = selectedFiles.length;
                summarySize.textContent = `${totalSizeMB} MB`;

                const selectedBrand = brands.find((brand) => String(brand.id) === marcaSelect.value);
                summaryBrand.textContent = selectedBrand ? selectedBrand.marca : 'Nenhuma';
            }

            function verifyImages() {
                verificationResults.innerHTML = '';

                if (selectedFiles.length === 0) {
                    verificationResults.innerHTML = '<p>Nenhuma imagem selecionada para verifica√ß√£o.</p>';
                    return false;
                }

                let allValid = true;

                selectedFiles.forEach((file) => {
                    const verificationItem = document.createElement('div');
                    verificationItem.className = 'verification-item';

                    const maxSize = 10 * 1024 * 1024;
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

                    let icon = '‚úÖ';
                    let message = `${file.name} - OK`;
                    let status = 'success';

                    if (!validTypes.includes(file.type)) {
                        icon = '‚ùå';
                        message = `${file.name} - Tipo de arquivo n√£o suportado`;
                        status = 'error';
                        allValid = false;
                    } else if (file.size > maxSize) {
                        icon = '‚ö†Ô∏è';
                        message = `${file.name} - Arquivo muito grande (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
                        status = 'warning';
                    }

                    verificationItem.innerHTML = `
                        <span class="verification-icon">${icon}</span>
                        <span class="verification-${status}">${message}</span>
                    `;

                    verificationResults.appendChild(verificationItem);
                });

                return allValid;
            }

            async function goToStep(step) {
                if (step === currentStep) {
                    return;
                }
                if (step === 2) {
                    if (selectedFiles.length === 0) {
                        alert('Por favor, selecione pelo menos uma imagem antes de continuar.');
                        return;
                    }
                    if (!marcaSelect.value) {
                        alert('Por favor, selecione uma marca antes de continuar.');
                        return;
                    }
                }

                if (step === 3) {
                    const allValid = verifyImages();
                    if (!allValid) {
                        alert('Algumas imagens n√£o passaram na verifica√ß√£o. Por favor, corrija os problemas antes de continuar.');
                        return;
                    }
                }

                if (step === 4) {
                    if (selectedFiles.length === 0) {
                        alert('Selecione ao menos uma imagem para importar.');
                        return;
                    }
                    try {
                        startImportBtn.disabled = true;
                        startImportBtn.textContent = 'Importando...';
                        const startTime = performance.now();
                        const result = await uploadSelectedFiles();
                        const duration = (performance.now() - startTime) / 1000;

                        const saved = Array.isArray(result.saved) ? result.saved : [];
                        importedCount.textContent = saved.length;
                        errorCount.textContent = 0;
                        processingTime.textContent = `${duration.toFixed(2)} segundos`;

                        successMessageText.textContent = saved.length
                            ? 'Todas as imagens foram importadas com sucesso.'
                            : 'Importa√ß√£o conclu√≠da.';
                        successMessage.classList.remove('hidden');
                        errorMessage.classList.add('hidden');

                        selectedFiles = [];
                        previewContainer.innerHTML = '';
                        updateSummary();
                        await loadReceipts();
                    } catch (error) {
                        importedCount.textContent = '0';
                        errorCount.textContent = `${selectedFiles.length}`;
                        processingTime.textContent = '0 segundos';
                        successMessage.classList.add('hidden');
                        errorMessageText.textContent = error.message;
                        errorMessage.classList.remove('hidden');
                        startImportBtn.disabled = false;
                        startImportBtn.textContent = 'Iniciar Importa√ß√£o';
                    }
                    startImportBtn.disabled = false;
                    startImportBtn.textContent = 'Iniciar Importa√ß√£o';
                }

                currentStep = step;
                const progressPercentage = ((step - 1) / (steps.length - 1)) * 100;
                progressBar.style.width = `${progressPercentage}%`;

                steps.forEach((s, index) => {
                    if (index + 1 < step) {
                        s.classList.remove('active');
                        s.classList.add('completed');
                    } else if (index + 1 === step) {
                        s.classList.add('active');
                        s.classList.remove('completed');
                    } else {
                        s.classList.remove('active', 'completed');
                    }
                });

                stepContents.forEach((content, index) => {
                    if (index + 1 === step) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async function uploadSelectedFiles() {
                const formData = new FormData();
                if (marcaSelect.value) {
                    formData.append('brand_id', marcaSelect.value);
                }
                selectedFiles.forEach((file) => {
                    formData.append('files', file, file.name);
                });

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || 'N√£o foi poss√≠vel importar as imagens.');
                }

                return response.json();
            }

            async function loadBrands() {
                try {
                    const response = await fetch('/api/brands');
                    if (!response.ok) {
                        throw new Error('N√£o foi poss√≠vel carregar as marcas.');
                    }
                    brands = await response.json();
                } catch (error) {
                    brands = [];
                    console.error(error);
                } finally {
                    populateBrandSelect(marcaSelect, 'Selecione uma marca');
                    populateBrandSelect(editReceiptBrand, 'Sem marca');
                    updateSummary();
                }
            }

            async function loadReceipts() {
                try {
                    const response = await fetch('/api/receipts');
                    if (!response.ok) {
                        throw new Error('N√£o foi poss√≠vel carregar os comprovantes.');
                    }
                    receipts = await response.json();
                } catch (error) {
                    receipts = [];
                    console.error(error);
                } finally {
                    updateReceiptsTable();
                }
            }

            function populateBrandSelect(selectElement, defaultLabel) {
                const previousValue = selectElement.value;
                selectElement.innerHTML = '';
                if (defaultLabel !== undefined && defaultLabel !== null) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = defaultLabel;
                    selectElement.appendChild(option);
                }
                const ordered = [...brands].sort((a, b) => a.marca.localeCompare(b.marca, 'pt-BR'));
                ordered.forEach((brand) => {
                    const option = document.createElement('option');
                    option.value = brand.id;
                    option.textContent = brand.marca;
                    selectElement.appendChild(option);
                });
                if (previousValue && ordered.some((brand) => String(brand.id) === previousValue)) {
                    selectElement.value = previousValue;
                }
            }

            function updateReceiptsTable() {
                receiptsTableBody.innerHTML = '';
                if (!receipts.length) {
                    receiptsEmptyMessage.style.display = 'block';
                    closeReceiptEditor();
                    return;
                }
                receiptsEmptyMessage.style.display = 'none';

                receipts.forEach((receipt) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="${receipt.url}" target="_blank" rel="noopener">${receipt.filename}</a></td>
                        <td>${receipt.brand || '‚Äî'}</td>
                        <td>${formatFileSize(receipt.size_bytes)}</td>
                        <td>${formatDateTime(receipt.uploaded_at)}</td>
                        <td class="actions-cell">
                            <button type="button" class="btn btn-secondary btn-small btn-edit-receipt" data-id="${receipt.id}">Editar</button>
                        </td>
                    `;
                    receiptsTableBody.appendChild(row);
                });
            }

            function startReceiptEdit(receiptId) {
                const receipt = receipts.find((item) => item.id === receiptId);
                if (!receipt) {
                    return;
                }
                populateBrandSelect(editReceiptBrand, 'Sem marca');
                editingReceiptId = receiptId;
                editReceiptId.value = receiptId;
                editFilename.value = receipt.filename;
                editReceiptBrand.value = receipt.brand_id ? String(receipt.brand_id) : '';
                displayEditMessage('Atualize as informa√ß√µes e salve as altera√ß√µes.', 'success');
                receiptEditContainer.classList.remove('hidden');
                receiptEditContainer.scrollIntoView({ behavior: 'smooth' });
            }

            function closeReceiptEditor() {
                editingReceiptId = null;
                editReceiptId.value = '';
                receiptEditForm.reset();
                displayEditMessage('', '');
                receiptEditContainer.classList.add('hidden');
            }

            function displayEditMessage(message, type = '') {
                receiptEditMessage.textContent = message;
                receiptEditMessage.className = type ? `form-message ${type}` : 'form-message';
            }

            function formatFileSize(bytes) {
                if (!bytes && bytes !== 0) {
                    return '0 B';
                }
                if (bytes >= 1024 * 1024) {
                    return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                }
                if (bytes >= 1024) {
                    return `${(bytes / 1024).toFixed(2)} KB`;
                }
                return `${bytes} B`;
            }

            function formatDateTime(value) {
                if (!value) {
                    return '‚Äî';
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return '‚Äî';
                }
                return date.toLocaleString('pt-BR');
            }
        });
    </script>

  </main>
</body>
</html>
