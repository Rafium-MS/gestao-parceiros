<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importa√ß√£o de Imagens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .progress-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 30px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e0e0e0;
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-bar {
            position: absolute;
            top: 50%;
            left: 0;
            height: 4px;
            background-color: #3498db;
            transform: translateY(-50%);
            z-index: 2;
            transition: width 0.3s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 3;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #777;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background-color: #3498db;
            color: white;
        }

        .step.completed .step-circle {
            background-color: #2ecc71;
            color: white;
        }

        .step-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: #777;
            text-align: center;
        }

        .step.active .step-text {
            color: #3498db;
        }

        .step.completed .step-text {
            color: #2ecc71;
        }

        .step-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .step-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background-color: #e8f4fc;
        }

        .upload-area.dragover {
            background-color: #d4e9f9;
            border-color: #2980b9;
        }

        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-prev {
            background-color: #95a5a6;
            color: white;
        }

        .btn-prev:hover {
            background-color: #7f8c8d;
        }

        .btn-next, .btn-submit {
            background-color: #3498db;
            color: white;
        }

        .btn-next:hover, .btn-submit:hover {
            background-color: #2980b9;
        }

        .btn-cancel {
            background-color: #e74c3c;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #c0392b;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .preview-info {
            padding: 8px;
            background-color: white;
        }

        .preview-name {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .preview-size {
            font-size: 0.7rem;
            color: #7f8c8d;
        }

        .preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .verification-results {
            margin-top: 20px;
        }

        .verification-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .verification-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .verification-success {
            color: #2ecc71;
        }

        .verification-warning {
            color: #f39c12;
        }

        .verification-error {
            color: #e74c3c;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eaeaea;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #34495e;
        }

        .summary-value {
            color: #2c3e50;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .progress-steps {
                flex-direction: column;
                align-items: flex-start;
            }

            .progress-steps::before {
                display: none;
            }

            .step {
                flex-direction: row;
                margin-bottom: 15px;
            }

            .step-circle {
                margin-right: 10px;
                margin-bottom: 0;
            }

            .btn-container {
                flex-direction: column;
                gap: 10px;
            }

            .btn-container button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<nav>
  <a href="/">In√≠cio</a>
  <a href="/parceiros">Parceiros</a>
  <a href="/lojas">Lojas</a>
  <a href="/conectar">Conectar</a>
  <a href="/comprovantes">Comprovantes</a>
  <a href="/relatorios">Relat√≥rios</a>
</nav>
    <div class="container">
        <header>
            <h1>Importa√ß√£o de Imagens</h1>
            <p>Processo de importa√ß√£o com etapas de verifica√ß√£o</p>
        </header>

        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-bar" id="progressBar"></div>
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Sele√ß√£o</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Verifica√ß√£o</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-text">Configura√ß√£o</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-text">Conclus√£o</div>
                </div>
            </div>
        </div>

        <!-- Etapa 1: Sele√ß√£o de Imagens -->
        <div class="step-content active" id="stepContent1">
            <h2>Sele√ß√£o de Imagens</h2>
            <p>Selecione as imagens que deseja importar para o sistema.</p>
            
            <div class="form-group">
                <label for="marca">Associar a Marca</label>
                <select id="marca" name="marca" required>
                    <option value="">Selecione uma marca</option>
                    <!-- As op√ß√µes ser√£o preenchidas via JavaScript -->
                </select>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Arraste e solte as imagens aqui</h3>
                <p>ou</p>
                <button type="button" class="btn-next" id="browseFiles">Procurar Arquivos</button>
                <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
            </div>
            
            <div class="preview-container" id="previewContainer">
                <!-- As pr√©-visualiza√ß√µes das imagens ser√£o inseridas aqui -->
            </div>
            
            <div class="btn-container">
                <div></div> <!-- Espa√ßo vazio para alinhamento -->
                <button type="button" class="btn-next" id="toStep2">Continuar para Verifica√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 2: Verifica√ß√£o -->
        <div class="step-content" id="stepContent2">
            <h2>Verifica√ß√£o de Imagens</h2>
            <p>Verificando as imagens selecionadas para garantir compatibilidade.</p>
            
            <div class="verification-results" id="verificationResults">
                <!-- Os resultados da verifica√ß√£o ser√£o inseridos aqui -->
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn-prev" id="toStep1">Voltar</button>
                <button type="button" class="btn-next" id="toStep3">Continuar para Configura√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 3: Configura√ß√£o -->
        <div class="step-content" id="stepContent3">
            <h2>Configura√ß√£o de Importa√ß√£o</h2>
            <p>Defina as op√ß√µes para a importa√ß√£o das imagens.</p>
            
            <div class="form-group">
                <label for="imageQuality">Qualidade da Imagem</label>
                <select id="imageQuality" name="imageQuality">
                    <option value="high">Alta (Melhor qualidade, maior tamanho)</option>
                    <option value="medium" selected>M√©dia (Balan√ßo entre qualidade e tamanho)</option>
                    <option value="low">Baixa (Menor qualidade, tamanho reduzido)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="imageSize">Redimensionar Imagens</label>
                <select id="imageSize" name="imageSize">
                    <option value="original">Manter tamanho original</option>
                    <option value="large">Grande (1920x1080px)</option>
                    <option value="medium" selected>M√©dio (1280x720px)</option>
                    <option value="small">Pequeno (800x600px)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="namingConvention">Conven√ß√£o de Nomes</label>
                <select id="namingConvention" name="namingConvention">
                    <option value="original">Manter nomes originais</option>
                    <option value="timestamp">Usar timestamp</option>
                    <option value="sequential" selected>Sequencial (imagem_001, imagem_002...)</option>
                </select>
            </div>
            
            <div class="summary-container">
                <h3>Resumo da Importa√ß√£o</h3>
                <div class="summary-item">
                    <span class="summary-label">Total de Imagens:</span>
                    <span class="summary-value" id="summaryCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tamanho Total:</span>
                    <span class="summary-value" id="summarySize">0 MB</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Marca Associada:</span>
                    <span class="summary-value" id="summaryBrand">Nenhuma</span>
                </div>
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn-prev" id="toStep2">Voltar</button>
                <button type="button" class="btn-submit" id="startImport">Iniciar Importa√ß√£o</button>
            </div>
        </div>

        <!-- Etapa 4: Conclus√£o -->
        <div class="step-content" id="stepContent4">
            <h2>Importa√ß√£o Conclu√≠da</h2>
            
            <div id="successMessage" class="alert alert-success hidden">
                <strong>Sucesso!</strong> Todas as imagens foram importadas com sucesso.
            </div>
            
            <div id="errorMessage" class="alert alert-error hidden">
                <strong>Erro!</strong> Ocorreu um problema durante a importa√ß√£o.
            </div>
            
            <div class="summary-container">
                <h3>Resultado da Importa√ß√£o</h3>
                <div class="summary-item">
                    <span class="summary-label">Imagens Importadas:</span>
                    <span class="summary-value" id="importedCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Imagens com Erro:</span>
                    <span class="summary-value" id="errorCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tempo de Processamento:</span>
                    <span class="summary-value" id="processingTime">0 segundos</span>
                </div>
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn-prev" id="toStep1">Importar Mais Imagens</button>
                <button type="button" class="btn-next" id="viewImages">Visualizar Imagens</button>
            </div>
        </div>
    </div>

    <script>

document.addEventListener('DOMContentLoaded', function() {
    const steps = document.querySelectorAll('.step');
    const stepContents = document.querySelectorAll('.step-content');
    const progressBar = document.getElementById('progressBar');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const browseFilesBtn = document.getElementById('browseFiles');
    const previewContainer = document.getElementById('previewContainer');
    const verificationResults = document.getElementById('verificationResults');
    const marcaSelect = document.getElementById('marca');

    const toStep2Btn = document.getElementById('toStep2');
    const toStep1From2Btn = document.getElementById('toStep1');
    const toStep3Btn = document.getElementById('toStep3');
    const toStep2From3Btn = document.getElementById('toStep2');
    const startImportBtn = document.getElementById('startImport');
    const toStep1From4Btn = document.getElementById('toStep1');
    const viewImagesBtn = document.getElementById('viewImages');

    const summaryCount = document.getElementById('summaryCount');
    const summarySize = document.getElementById('summarySize');
    const summaryBrand = document.getElementById('summaryBrand');
    const importedCount = document.getElementById('importedCount');
    const errorCount = document.getElementById('errorCount');
    const processingTime = document.getElementById('processingTime');

    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    let currentStep = 1;
    let selectedFiles = [];
    let brands = [];

    async function loadBrands(){
        brands = await (await fetch('/api/brands')).json();
        marcaSelect.innerHTML = '<option value="">Selecione uma marca</option>';
        brands.forEach(b => {
            const o = document.createElement('option');
            o.value = b.id;
            o.textContent = b.marca;
            marcaSelect.appendChild(o);
        });
    }

    function goToStep(step){
        currentStep = step;
        const progressPercentage = ((step - 1) / (steps.length - 1)) * 100;
        progressBar.style.width = `${progressPercentage}%`;
        steps.forEach((s, idx) => {
            if (idx+1 < step){ s.classList.add('completed'); s.classList.remove('active'); }
            else if (idx+1 === step){ s.classList.add('active'); s.classList.remove('completed'); }
            else { s.classList.remove('active','completed'); }
        });
        stepContents.forEach((c, idx)=>{
            c.classList.toggle('active', idx+1===step);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Upload UI
    browseFilesBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', (e)=>{ handleFiles(e.target.files); fileInput.value=''; });
    uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e)=>{
        e.preventDefault(); uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files){
        for (let i=0; i<files.length; i++){
            const f = files[i];
            if (!f.type.match('image.*')){ alert(`"${f.name}" n√£o √© imagem.`); continue; }
            if (selectedFiles.some(x=>x.name===f.name && x.size===f.size)) continue;
            selectedFiles.push(f);
            createPreview(f);
        }
        updateSummary();
    }

    function createPreview(file){
        const reader = new FileReader();
        reader.onload = (e)=>{
            const div = document.createElement('div');
            div.className='preview-item';
            const sizeMB = (file.size/(1024*1024)).toFixed(2);
            div.innerHTML = `
                <img src="${e.target.result}" class="preview-image" alt="${file.name}">
                <div class="preview-info">
                    <div class="preview-name">${file.name}</div>
                    <div class="preview-size">${sizeMB} MB</div>
                </div>
                <button class="preview-remove" data-fn="${file.name}">√ó</button>`;
            div.querySelector('.preview-remove').addEventListener('click', ()=>{
                selectedFiles = selectedFiles.filter(x=>x.name!==file.name);
                previewContainer.removeChild(div);
                updateSummary();
            });
            previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
    }

    function updateSummary(){
        const totalSize = selectedFiles.reduce((a,f)=>a+f.size,0);
        summaryCount.textContent = selectedFiles.length;
        summarySize.textContent = (totalSize/(1024*1024)).toFixed(2)+' MB';
        const idx = marcaSelect.value;
        const b = brands.find(x=> String(x.id)===String(idx));
        summaryBrand.textContent = b ? b.marca : 'Nenhuma';
    }

    function verifyImages(){
        verificationResults.innerHTML='';
        if (selectedFiles.length===0){ verificationResults.innerHTML='<p>Nenhuma imagem selecionada.</p>'; return false; }
        const validTypes = ['image/jpeg','image/png','image/gif','image/webp'];
        let allValid = true;
        selectedFiles.forEach(f=>{
            let icon='‚úÖ', status='success', msg=`${f.name} - OK`;
            if (!validTypes.includes(f.type)){ icon='‚ùå'; status='error'; msg=`${f.name} - Tipo n√£o suportado`; allValid=false; }
            else if (f.size > 10*1024*1024){ icon='‚ö†Ô∏è'; status='warning'; msg=`${f.name} - Arquivo grande ${(f.size/(1024*1024)).toFixed(2)}MB`; }
            const row = document.createElement('div');
            row.className='verification-item';
            row.innerHTML = `<span class="verification-icon">${icon}</span><span class="verification-${status}">${msg}</span>`;
            verificationResults.appendChild(row);
        });
        return allValid;
    }

    async function performUpload(){
        const t0 = performance.now();
        let ok=0, err=0;
        const fd = new FormData();
        const brandId = marcaSelect.value;
        if (!brandId){ alert('Selecione uma marca antes.'); return {ok:0,err:selectedFiles.length,dur:0}; }
        fd.append('brand_id', brandId);
        selectedFiles.forEach(f => fd.append('files', f));
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        if (res.ok){
            const data = await res.json();
            ok = Array.isArray(data.saved) ? data.saved.length : 0;
            err = Math.max(0, selectedFiles.length - ok);
        } else {
            err = selectedFiles.length;
        }
        const dur = (performance.now()-t0)/1000;
        return {ok, err, dur};
    }

    // Navigation rules
    toStep2Btn.addEventListener('click', ()=>{
        if (!marcaSelect.value){ alert('Selecione uma marca.'); return; }
        if (selectedFiles.length===0){ alert('Selecione ao menos uma imagem.'); return; }
        goToStep(2);
    });
    toStep1From2Btn.addEventListener('click', ()=>goToStep(1));
    toStep3Btn.addEventListener('click', ()=>{
        if (!verifyImages()){ alert('Corrija os problemas antes de continuar.'); return; }
        goToStep(3);
    });
    toStep2From3Btn.addEventListener('click', ()=>goToStep(2));
    startImportBtn.addEventListener('click', async ()=>{
        startImportBtn.disabled=true; startImportBtn.textContent='Importando...';
        const results = await performUpload();
        importedCount.textContent = results.ok;
        errorCount.textContent = results.err;
        processingTime.textContent = results.dur.toFixed(2) + ' segundos';
        successMessage.classList.toggle('hidden', results.err>0);
        errorMessage.classList.toggle('hidden', results.err===0);
        startImportBtn.disabled=false; startImportBtn.textContent='Iniciar Importa√ß√£o';
        goToStep(4);
    });
    toStep1From4Btn.addEventListener('click', ()=>{ selectedFiles=[]; previewContainer.innerHTML=''; updateSummary(); goToStep(1); });
    viewImagesBtn.addEventListener('click', ()=>{ window.open('/uploads/','_blank'); });

    marcaSelect.addEventListener('change', updateSummary);
    loadBrands().then(()=>goToStep(1));
});

</script>
</body>
</html>