<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Marcas e Lojas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-group {
            flex: 1 0 200px;
            margin: 0 10px 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit {
            background-color: #2ecc71;
            color: white;
        }

        .btn-submit:hover {
            background-color: #27ae60;
        }

        .btn-reset {
            background-color: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background-color: #c0392b;
        }

        .brands-list {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .list-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .empty-message {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .prices-section .form-group {
            flex: 1 0 180px;
        }

        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: "R$";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-weight: 600;
        }

        .currency-input input {
            padding-left: 35px;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background-color: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background-color: #2980b9;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .brand-header {
            background-color: #e8f4fc;
            font-weight: bold;
            cursor: pointer;
        }

        .brand-header:hover {
            background-color: #d4e9f9;
        }

        .brand-details {
            display: none;
        }

        .brand-expanded .brand-details {
            display: table-row;
        }

        .brand-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .add-store-btn {
            background-color: #9b59b6;
            color: white;
            padding: 8px 15px;
            font-size: 0.85rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-store-btn:hover {
            background-color: #8e44ad;
        }

        @media (max-width: 768px) {
            .form-group {
                flex: 1 0 100%;
            }
            
            .prices-section .form-group {
                flex: 1 0 calc(50% - 20px);
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .actions-cell {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<nav>
  <a href="/">Início</a>
  <a href="/parceiros">Parceiros</a>
  <a href="/lojas">Lojas</a>
  <a href="/conectar">Conectar</a>
  <a href="/comprovantes">Comprovantes</a>
  <a href="/relatorios">Relatórios</a>
</nav>
    <div class="container">
        <header>
            <h1>Cadastro de Marcas e Lojas</h1>
            <p>Sistema para cadastro e gerenciamento de marcas e lojas parceiras</p>
        </header>

        <div class="form-container">
            <h2 class="section-title">Cadastro de Marcas</h2>
            <form id="brandForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="marca">NOME DA MARCA</label>
                        <input type="text" id="marca" name="marca" required>
                    </div>
                </div>
                	<!-- cadastrar marca poderia ser um modal -->	
                <div class="btn-container">
                    <button type="submit" class="btn-submit">Cadastrar Marca</button>
                    <button type="reset" class="btn-reset">Limpar Formulário</button>
                </div>
            </form>
        </div>

        <div class="form-container">
            <h2 class="section-title">Cadastro de Lojas</h2>
            <form id="storeForm">
                <div class="form-section">
                    <div class="form-row">

                        <div class="form-group">
                            <label for="marca_id">MARCA</label>
                            <select id="marca_id" name="marca_id" required>
                                <option value="">Selecione uma marca</option>
                                <!-- As opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loja">NOME DA LOJA</label>
                            <input type="text" id="loja" name="loja" required>
                        </div>
                    </div>
					                   <div class="form-group">
                        <label for="cod_disagua">COD da Disagua</label>
                        <input type="text" id="cod_disagua" name="cod_disagua">
                    </div>
                </div>
					
                <div class="form-section">
                    <h2 class="section-title">Localização</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="local_entrega">LOCAL DA ENTREGA</label>
                            <input type="text" id="local_entrega" name="local_entrega" required>
                        </div>
                        <div class="form-group">
                            <label for="endereco">ENDEREÇO</label>
                            <input type="text" id="endereco" name="endereco">
                        </div>
                        <div class="form-group">
                            <label for="municipio">MUNICIPIO</label>
                            <input type="text" id="municipio" name="municipio" required>
                        </div>
                        <div class="form-group">
                            <label for="uf">UF</label>
                            <select id="uf" name="uf" required>
                                <option value="">Selecione</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amapá</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Ceará</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Espírito Santo</option>
                                <option value="GO">Goiás</option>
                                <option value="MA">Maranhão</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Pará</option>
                                <option value="PB">Paraíba</option>
                                <option value="PR">Paraná</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piauí</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rondônia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">São Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section prices-section">
                    <h2 class="section-title">Valores dos Produtos</h2>
                    <div class="form-row">
                        <div class="form-group currency-input">
                            <label for="valor_20l">VALOR 20 LITROS</label>
                            <input type="number" id="valor_20l" name="valor_20l" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group currency-input">
                            <label for="valor_10l">VALOR 10 LITROS</label>
                            <input type="number" id="valor_10l" name="valor_10l" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group currency-input">
                            <label for="valor_1500ml">VALOR 1500 ML</label>
                            <input type="number" id="valor_1500ml" name="valor_1500ml" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group currency-input">
                            <label for="valor_cx_copo">VALOR CX COPO</label>
                            <input type="number" id="valor_cx_copo" name="valor_cx_copo" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group currency-input">
                            <label for="valor_vasilhame">VALOR VASILHAME</label>
                            <input type="number" id="valor_vasilhame" name="valor_vasilhame" min="0" step="0.01" value="0">
                        </div>
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn-submit">Cadastrar Loja</button>
                    <button type="reset" class="btn-reset">Limpar Formulário</button>
                </div>
            </form>
        </div>

        <div class="brands-list">
            <div class="list-header">
                Marcas e Lojas Cadastradas
            </div>
            <table id="brandsTable">
                <thead>
                    <tr>
                        <th>MARCA</th>
                        <th>COD DISAGUA</th>
                        <th>LOJAS</th>
                        <th>AÇÕES</th>
                    </tr>
                </thead>
                <tbody id="brandsTableBody">
                    <!-- Dados serão inseridos aqui via JavaScript -->
                </tbody>
            </table>
            <div id="emptyMessage" class="empty-message">
                Nenhuma marca cadastrada ainda.
            </div>
        </div>
    </div>

    <script>

document.addEventListener('DOMContentLoaded', function() {
    const brandForm = document.getElementById('brandForm');
    const storeForm = document.getElementById('storeForm');
    const brandsTableBody = document.getElementById('brandsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    const marcaSelect = document.getElementById('marca_id');

    let editingBrandId = null;
    let editingStoreId = null;

    async function getBrands(){ const r = await fetch('/api/brands'); return await r.json(); }
    async function getStores(){ const r = await fetch('/api/stores'); return await r.json(); }

    async function refreshSelect() {
        marcaSelect.innerHTML = '<option value="">Selecione uma marca</option>';
        const brands = await getBrands();
        brands.forEach(b => {
            const option = document.createElement('option');
            option.value = b.id;
            option.textContent = b.marca;
            marcaSelect.appendChild(option);
        });
    }

    function BRL(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v||0)); }

    async function refreshTable() {
        brandsTableBody.innerHTML='';
        const brands = await getBrands();
        const stores = await getStores();

        if (brands.length===0){
            emptyMessage.style.display='block';
            return;
        }
        emptyMessage.style.display='none';

        brands.forEach(b => {
            const brandStores = stores.filter(s => Number(s.marca_id) === Number(b.id));
            const brandRow = document.createElement('tr');
            brandRow.className='brand-header';
            brandRow.innerHTML = `
                <td class="brand-name">${b.marca}</td>
                <td>${b.cod_disagua||''}</td>
                <td>${brandStores.length} loja(s)</td>
                <td class="actions-cell">
                    <button class="btn-edit" data-id="${b.id}">Editar</button>
                    <button class="btn-delete" data-id="${b.id}">Excluir</button>
                    <button class="add-store-btn" data-id="${b.id}">+ Loja</button>
                </td>
            `;
            brandsTableBody.appendChild(brandRow);

            const detailsRow = document.createElement('tr');
            if (brandStores.length===0){
                detailsRow.innerHTML = `<td colspan="4" style="text-align:center; color:#7f8c8d;">Nenhuma loja cadastrada para esta marca.</td>`;
            } else {
                let rows = brandStores.map(st => `
                    <tr data-storeid="${st.id}">
                        <td>${st.loja}</td>
                        <td>${st.local_entrega||''}</td>
                        <td>${st.endereco||''}</td>
                        <td>${st.municipio}</td>
                        <td>${st.uf}</td>
                        <td>${BRL(st.valor_20l)}</td>
                        <td>${BRL(st.valor_10l)}</td>
                        <td>${BRL(st.valor_1500ml)}</td>
                        <td>${BRL(st.valor_cx_copo)}</td>
                        <td>${BRL(st.valor_vasilhame)}</td>
                        <td class="actions-cell">
                            <button class="btn-edit-store" data-id="${st.id}">Editar</button>
                            <button class="btn-delete-store" data-id="${st.id}">Excluir</button>
                        </td>
                    </tr>
                `).join('');
                detailsRow.innerHTML = `
                    <td colspan="4">
                        <table style="width:100%; background:#f9f9f9">
                            <thead>
                                <tr>
                                    <th>LOJA</th><th>LOCAL ENTREGA</th><th>ENDEREÇO</th><th>MUNICÍPIO</th><th>UF</th>
                                    <th>VALOR 20L</th><th>VALOR 10L</th><th>VALOR 1500ML</th><th>VALOR CX COPO</th><th>VALOR VASILHAME</th><th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </td>`;
            }
            brandsTableBody.appendChild(detailsRow);

            brandRow.addEventListener('click', (e)=>{
                const t = e.target;
                if (t.tagName==='BUTTON') return;
                detailsRow.style.display = (detailsRow.style.display==='table-row') ? 'none':'table-row';
            });
            brandRow.querySelector('.add-store-btn').addEventListener('click', (e)=>{
                const id = e.target.getAttribute('data-id');
                marcaSelect.value = id;
                document.getElementById('storeForm').scrollIntoView({behavior:'smooth'});
            });
            brandRow.querySelector('.btn-edit').addEventListener('click', (e)=>{
                const id = Number(e.target.getAttribute('data-id'));
                editingBrandId = id;
                document.getElementById('marca').value = b.marca;
                document.getElementById('cod_disagua').value = b.cod_disagua || '';
                document.querySelector('#brandForm .btn-submit').textContent = 'Atualizar Marca';
                window.scrollTo({top:0, behavior:'smooth'});
            });
            brandRow.querySelector('.btn-delete').addEventListener('click', async (e)=>{
                const id = Number(e.target.getAttribute('data-id'));
                if (!confirm('Excluir esta marca e lojas associadas?')) return;
                const r = await fetch(`/api/brands/${id}`, { method:'DELETE' });
                if (!r.ok){ alert('Erro ao excluir marca.'); return; }
                await refreshSelect();
                await refreshTable();
            });

            detailsRow.querySelectorAll('.btn-edit-store')?.forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    const sid = Number(e.target.getAttribute('data-id'));
                    const st = brandStores.find(x=> Number(x.id)===sid);
                    if (!st) return;
                    editingStoreId = sid;
                    document.getElementById('marca_id').value = b.id;
                    document.getElementById('loja').value = st.loja;
                    document.getElementById('local_entrega').value = st.local_entrega || '';
                    document.getElementById('endereco').value = st.endereco || '';
                    document.getElementById('municipio').value = st.municipio;
                    document.getElementById('uf').value = st.uf;
                    document.getElementById('valor_20l').value = st.valor_20l||0;
                    document.getElementById('valor_10l').value = st.valor_10l||0;
                    document.getElementById('valor_1500ml').value = st.valor_1500ml||0;
                    document.getElementById('valor_cx_copo').value = st.valor_cx_copo||0;
                    document.getElementById('valor_vasilhame').value = st.valor_vasilhame||0;
                    document.querySelector('#storeForm .btn-submit').textContent = 'Atualizar Loja';
                    document.getElementById('storeForm').scrollIntoView({behavior:'smooth'});
                });
            });
            detailsRow.querySelectorAll('.btn-delete-store')?.forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                    const sid = Number(e.target.getAttribute('data-id'));
                    if (!confirm('Excluir esta loja?')) return;
                    const r = await fetch(`/api/stores/${sid}`, { method:'DELETE' });
                    if (!r.ok){ alert('Erro ao excluir loja.'); return; }
                    await refreshTable();
                });
            });
        });
    }

    brandForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(brandForm);
        const payload = { marca: fd.get('marca'), cod_disagua: fd.get('cod_disagua') || '' };
        let res;
        if (editingBrandId){
            res = await fetch(`/api/brands/${editingBrandId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        } else {
            res = await fetch('/api/brands', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }
        if(!res.ok){ alert('Erro ao salvar marca'); return; }
        brandForm.reset();
        editingBrandId = null;
        document.querySelector('#brandForm .btn-submit').textContent = 'Cadastrar Marca';
        await refreshSelect();
        await refreshTable();
        alert('Marca salva com sucesso!');
    });

    brandForm.addEventListener('reset', ()=>{
        editingBrandId = null;
        document.querySelector('#brandForm .btn-submit').textContent = 'Cadastrar Marca';
    });

    storeForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(storeForm);
        const payload = {
            marca_id: Number(fd.get('marca_id')),
            loja: fd.get('loja'),
            cod_disagua: fd.get('cod_disagua') || '',
            local_entrega: fd.get('local_entrega'),
            endereco: fd.get('endereco') || '',
            municipio: fd.get('municipio'),
            uf: fd.get('uf'),
            valor_20l: Number(fd.get('valor_20l')||0),
            valor_10l: Number(fd.get('valor_10l')||0),
            valor_1500ml: Number(fd.get('valor_1500ml')||0),
            valor_cx_copo: Number(fd.get('valor_cx_copo')||0),
            valor_vasilhame: Number(fd.get('valor_vasilhame')||0),
        };
        let res;
        if (editingStoreId){
            res = await fetch(`/api/stores/${editingStoreId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        } else {
            res = await fetch('/api/stores', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }
        if(!res.ok){ alert('Erro ao salvar loja'); return; }
        storeForm.reset();
        editingStoreId = null;
        document.querySelector('#storeForm .btn-submit').textContent = 'Cadastrar Loja';
        await refreshTable();
        alert('Loja salva com sucesso!');
    });

    storeForm.addEventListener('reset', ()=>{
        editingStoreId = null;
        document.querySelector('#storeForm .btn-submit').textContent = 'Cadastrar Loja';
    });

    (async () => { await refreshSelect(); await refreshTable(); })();
});

</script>
</body>
</html>