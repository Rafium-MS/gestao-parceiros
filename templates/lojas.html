<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Marcas e Lojas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container container-wide">
      <header class="section-header">
        <h1>Cadastro de Marcas e Lojas</h1>
        <p>Sistema para cadastro e gerenciamento de marcas e lojas parceiras</p>
      </header>

      <div class="form-container">
        <h2 class="section-title">Cadastro de Marcas</h2>
        <form id="brandForm">
          <div class="form-row">
            <div class="form-group">
              <label for="marca">Nome da marca</label>
              <input type="text" id="marca" name="marca" required>
            </div>
            <div class="form-group">
              <label for="cod_disagua">Código Disagua</label>
              <input type="text" id="cod_disagua" name="cod_disagua" placeholder="Opcional">
            </div>
          </div>
          <div class="btn-container">
            <button type="submit" class="btn btn-submit">Cadastrar marca</button>
            <button type="reset" class="btn btn-reset">Limpar formulário</button>
          </div>
        </form>
      </div>

      <div class="form-container">
        <h2 class="section-title">Cadastro de Lojas</h2>
        <form id="storeForm">
          <div class="form-section">
            <div class="form-row">
              <div class="form-group">
                <label for="marca_id">Marca</label>
                <select id="marca_id" name="marca_id" required>
                  <option value="">Selecione uma marca</option>
                </select>
              </div>
              <div class="form-group">
                <label for="loja">Nome da loja</label>
                <input type="text" id="loja" name="loja" required>
              </div>
              <div class="form-group">
                <label for="local_entrega">Local da entrega</label>
                <input type="text" id="local_entrega" name="local_entrega" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="endereco">Endereço</label>
                <input type="text" id="endereco" name="endereco">
              </div>
              <div class="form-group">
                <label for="municipio">Município</label>
                <input type="text" id="municipio" name="municipio" required>
              </div>
              <div class="form-group">
                <label for="uf">UF</label>
                <select id="uf" name="uf" required>
                  <option value="">Selecione</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amapá</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Ceará</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Espírito Santo</option>
                  <option value="GO">Goiás</option>
                  <option value="MA">Maranhão</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Pará</option>
                  <option value="PB">Paraíba</option>
                  <option value="PR">Paraná</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piauí</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rondônia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">São Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section prices-section">
            <h3 class="section-title">Valores dos produtos</h3>
            <div class="form-row">
              <div class="form-group currency-input">
                <label for="valor_20l">Valor 20 litros</label>
                <input type="number" id="valor_20l" name="valor_20l" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_10l">Valor 10 litros</label>
                <input type="number" id="valor_10l" name="valor_10l" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_1500ml">Valor 1500 ml</label>
                <input type="number" id="valor_1500ml" name="valor_1500ml" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_cx_copo">Valor CX copo</label>
                <input type="number" id="valor_cx_copo" name="valor_cx_copo" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_vasilhame">Valor vasilhame</label>
                <input type="number" id="valor_vasilhame" name="valor_vasilhame" min="0" step="0.01" value="0">
              </div>
            </div>
          </div>

          <div class="btn-container">
            <button type="submit" class="btn btn-submit">Cadastrar loja</button>
            <button type="reset" class="btn btn-reset">Limpar formulário</button>
          </div>
        </form>
      </div>

      <div class="brands-list">
        <div class="list-header">Marcas e lojas cadastradas</div>
        <div class="table-wrapper">
          <table id="brandsTable">
            <thead>
              <tr>
                <th>Marca</th>
                <th>Código Disagua</th>
                <th>Lojas</th>
                <th class="column-actions">Ações</th>
              </tr>
            </thead>
            <tbody id="brandsTableBody"></tbody>
          </table>
        </div>
        <p id="emptyMessage" class="empty-message">Nenhuma marca cadastrada ainda.</p>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const brandForm = document.getElementById('brandForm');
    const storeForm = document.getElementById('storeForm');
    const brandsTableBody = document.getElementById('brandsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    const marcaSelect = document.getElementById('marca_id');
    const brandSubmitBtn = brandForm.querySelector('.btn-submit');
    const storeSubmitBtn = storeForm.querySelector('.btn-submit');

    let brands = JSON.parse(localStorage.getItem('brands')) || [];
    let stores = JSON.parse(localStorage.getItem('stores')) || [];

    let editingBrandIndex = -1;
    let editingStoreIndex = -1;

    updateBrandsTable();
    updateBrandsSelect();

    function updateBrandsSelect() {
      marcaSelect.innerHTML = '<option value="">Selecione uma marca</option>';
      brands.forEach((brand, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = brand.marca;
        marcaSelect.appendChild(option);
      });
    }

    function updateBrandsTable() {
      brandsTableBody.innerHTML = '';

      if (brands.length === 0) {
        emptyMessage.style.display = 'block';
        return;
      }

      emptyMessage.style.display = 'none';

      const currency = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

      brands.forEach((brand, brandIndex) => {
        const brandStores = stores.filter(store => store.marca_id == brandIndex);
        const brandRow = document.createElement('tr');
        brandRow.className = 'brand-header';
        brandRow.dataset.brandIndex = brandIndex;
        brandRow.innerHTML = `
          <td class="brand-name">${brand.marca}</td>
          <td>${brand.cod_disagua || '-'}</td>
          <td>${brandStores.length} loja(s)</td>
          <td class="actions-cell">
            <button type="button" class="btn btn-secondary btn-small" onclick="editBrand(${brandIndex})">Editar</button>
            <button type="button" class="btn btn-danger btn-small" onclick="deleteBrand(${brandIndex})">Excluir</button>
            <button type="button" class="btn btn-primary btn-small" onclick="addStoreToBrand(${brandIndex})">+ Loja</button>
          </td>
        `;
        brandsTableBody.appendChild(brandRow);

        brandRow.addEventListener('click', function(e) {
          if (e.target.tagName === 'BUTTON') return;
          this.classList.toggle('brand-expanded');
        });

        const detailsRow = document.createElement('tr');
        detailsRow.className = 'brand-details';

        if (brandStores.length === 0) {
          detailsRow.innerHTML = '<td colspan="4" class="text-center text-muted">Nenhuma loja cadastrada para esta marca.</td>';
        } else {
          let storesHTML = '<td colspan="4"><div class="table-wrapper"><table class="table-compact"><thead><tr>' +
            '<th>Loja</th><th>Local entrega</th><th>Endereço</th><th>Município</th><th>UF</th>' +
            '<th>Valor 20L</th><th>Valor 10L</th><th>Valor 1500ml</th><th>Valor CX copo</th><th>Valor vasilhame</th><th>Ações</th>' +
            '</tr></thead><tbody>';

          brandStores.forEach((store, storeIndex) => {
            storesHTML += `
              <tr>
                <td>${store.loja}</td>
                <td>${store.local_entrega}</td>
                <td>${store.endereco || '-'}</td>
                <td>${store.municipio}</td>
                <td>${store.uf}</td>
                <td>${currency.format(parseFloat(store.valor_20l) || 0)}</td>
                <td>${currency.format(parseFloat(store.valor_10l) || 0)}</td>
                <td>${currency.format(parseFloat(store.valor_1500ml) || 0)}</td>
                <td>${currency.format(parseFloat(store.valor_cx_copo) || 0)}</td>
                <td>${currency.format(parseFloat(store.valor_vasilhame) || 0)}</td>
                <td class="actions-cell">
                  <button type="button" class="btn btn-secondary btn-small" onclick="editStore(${brandIndex}, ${storeIndex})">Editar</button>
                  <button type="button" class="btn btn-danger btn-small" onclick="deleteStore(${brandIndex}, ${storeIndex})">Excluir</button>
                </td>
              </tr>`;
          });

          storesHTML += '</tbody></table></div></td>';
          detailsRow.innerHTML = storesHTML;
        }

        brandsTableBody.appendChild(detailsRow);
      });
    }

    window.addStoreToBrand = function(brandIndex) {
      marcaSelect.value = brandIndex;
      storeForm.scrollIntoView({ behavior: 'smooth' });
    };

    window.editBrand = function(index) {
      const brand = brands[index];
      document.getElementById('marca').value = brand.marca;
      document.getElementById('cod_disagua').value = brand.cod_disagua || '';
      brandSubmitBtn.textContent = 'Atualizar marca';
      editingBrandIndex = index;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.editStore = function(brandIndex, storeIndex) {
      const store = stores.find((store, idx) => store.marca_id == brandIndex && stores.indexOf(store) === storeIndex);
      if (!store) return;
      marcaSelect.value = brandIndex;
      document.getElementById('loja').value = store.loja;
      document.getElementById('local_entrega').value = store.local_entrega;
      document.getElementById('endereco').value = store.endereco;
      document.getElementById('municipio').value = store.municipio;
      document.getElementById('uf').value = store.uf;
      document.getElementById('valor_20l').value = store.valor_20l;
      document.getElementById('valor_10l').value = store.valor_10l;
      document.getElementById('valor_1500ml').value = store.valor_1500ml;
      document.getElementById('valor_cx_copo').value = store.valor_cx_copo;
      document.getElementById('valor_vasilhame').value = store.valor_vasilhame;
      storeSubmitBtn.textContent = 'Atualizar loja';
      editingStoreIndex = storeIndex;
      storeForm.scrollIntoView({ behavior: 'smooth' });
    };

    window.deleteBrand = function(index) {
      if (!confirm('Tem certeza que deseja excluir esta marca?')) return;
      brands.splice(index, 1);
      stores = stores.filter(store => store.marca_id != index).map(store => {
        if (store.marca_id > index) {
          store.marca_id--;
        }
        return store;
      });
      localStorage.setItem('brands', JSON.stringify(brands));
      localStorage.setItem('stores', JSON.stringify(stores));
      updateBrandsTable();
      updateBrandsSelect();
      alert('Marca e lojas associadas excluídas com sucesso!');
    };

    window.deleteStore = function(brandIndex, storeIndex) {
      if (!confirm('Tem certeza que deseja excluir esta loja?')) return;
      const globalStoreIndex = stores.findIndex(store => store.marca_id == brandIndex && stores.indexOf(store) === storeIndex);
      if (globalStoreIndex !== -1) {
        stores.splice(globalStoreIndex, 1);
        localStorage.setItem('stores', JSON.stringify(stores));
        updateBrandsTable();
        alert('Loja excluída com sucesso!');
      }
    };

    brandForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(brandForm);
      const brandData = {};
      for (let [key, value] of formData.entries()) {
        brandData[key] = value;
      }
      if (editingBrandIndex === -1) {
        brands.push(brandData);
        alert('Marca cadastrada com sucesso!');
      } else {
        brands[editingBrandIndex] = brandData;
        alert('Marca atualizada com sucesso!');
        editingBrandIndex = -1;
        brandSubmitBtn.textContent = 'Cadastrar marca';
      }
      localStorage.setItem('brands', JSON.stringify(brands));
      updateBrandsTable();
      updateBrandsSelect();
      brandForm.reset();
    });

    storeForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(storeForm);
      const storeData = {};
      for (let [key, value] of formData.entries()) {
        storeData[key] = value;
      }
      storeData.marca_id = parseInt(storeData.marca_id);
      if (isNaN(storeData.marca_id)) {
        alert('Selecione uma marca para a loja.');
        return;
      }
      if (editingStoreIndex === -1) {
        stores.push(storeData);
        alert('Loja cadastrada com sucesso!');
      } else {
        const globalStoreIndex = stores.findIndex(store => store.marca_id == storeData.marca_id && stores.indexOf(store) === editingStoreIndex);
        if (globalStoreIndex !== -1) {
          stores[globalStoreIndex] = storeData;
          alert('Loja atualizada com sucesso!');
        }
        editingStoreIndex = -1;
        storeSubmitBtn.textContent = 'Cadastrar loja';
      }
      localStorage.setItem('stores', JSON.stringify(stores));
      updateBrandsTable();
      storeForm.reset();
    });

    brandForm.addEventListener('reset', function() {
      editingBrandIndex = -1;
      brandSubmitBtn.textContent = 'Cadastrar marca';
    });

    storeForm.addEventListener('reset', function() {
      editingStoreIndex = -1;
      storeSubmitBtn.textContent = 'Cadastrar loja';
    });
  });
  </script>
  </main>
</body>
</html>
