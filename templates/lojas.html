<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Marcas e Lojas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container container-wide">
      <header class="section-header">
        <h1>Cadastro de Marcas e Lojas</h1>
        <p>Sistema para cadastro e gerenciamento de marcas e lojas parceiras</p>
      </header>

      <div class="form-container">
        <h2 class="section-title">Cadastro de Marcas</h2>
        <form id="brandForm">
          <div class="form-row">
            <div class="form-group">
              <label for="marca">Nome da marca</label>
              <input type="text" id="marca" name="marca" required>
            </div>
            <div class="form-group">
              <label for="cod_disagua">Código Disagua</label>
              <input type="text" id="cod_disagua" name="cod_disagua" placeholder="Opcional">
            </div>
          </div>
          <div class="btn-container">
            <button type="submit" class="btn btn-submit" id="brandSubmitBtn">Cadastrar marca</button>
            <button type="reset" class="btn btn-reset">Limpar formulário</button>
          </div>
          <div id="brandFormMessage" class="form-message" role="status" aria-live="polite"></div>
        </form>
      </div>

      <div class="form-container">
        <h2 class="section-title">Cadastro de Lojas</h2>
        <form id="storeForm">
          <div class="form-section">
            <div class="form-row">
              <div class="form-group">
                <label for="marca_id">Marca</label>
                <select id="marca_id" name="marca_id" required>
                  <option value="">Selecione uma marca</option>
                </select>
              </div>
              <div class="form-group">
                <label for="loja">Nome da loja</label>
                <input type="text" id="loja" name="loja" required>
              </div>
              <div class="form-group">
                <label for="cod_disagua_loja">Código Disagua</label>
                <input type="text" id="cod_disagua_loja" name="cod_disagua" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label for="local_entrega">Local da entrega</label>
                <input type="text" id="local_entrega" name="local_entrega" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="endereco">Endereço</label>
                <input type="text" id="endereco" name="endereco">
              </div>
              <div class="form-group">
                <label for="municipio">Município</label>
                <input type="text" id="municipio" name="municipio" required>
              </div>
              <div class="form-group">
                <label for="uf">UF</label>
                <select id="uf" name="uf" required>
                  <option value="">Selecione</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amapá</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Ceará</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Espírito Santo</option>
                  <option value="GO">Goiás</option>
                  <option value="MA">Maranhão</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Pará</option>
                  <option value="PB">Paraíba</option>
                  <option value="PR">Paraná</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piauí</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rondônia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">São Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section prices-section">
            <h3 class="section-title">Valores dos produtos</h3>
            <div class="form-row">
              <div class="form-group currency-input">
                <label for="valor_20l">Valor 20 litros</label>
                <input type="number" id="valor_20l" name="valor_20l" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_10l">Valor 10 litros</label>
                <input type="number" id="valor_10l" name="valor_10l" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_1500ml">Valor 1500 ml</label>
                <input type="number" id="valor_1500ml" name="valor_1500ml" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_cx_copo">Valor CX copo</label>
                <input type="number" id="valor_cx_copo" name="valor_cx_copo" min="0" step="0.01" value="0">
              </div>
              <div class="form-group currency-input">
                <label for="valor_vasilhame">Valor vasilhame</label>
                <input type="number" id="valor_vasilhame" name="valor_vasilhame" min="0" step="0.01" value="0">
              </div>
            </div>
          </div>

          <div class="btn-container">
            <button type="submit" class="btn btn-submit" id="storeSubmitBtn">Cadastrar loja</button>
            <button type="reset" class="btn btn-reset">Limpar formulário</button>
          </div>
          <div id="storeFormMessage" class="form-message" role="status" aria-live="polite"></div>
        </form>
      </div>

      <div class="brands-list">
        <div class="list-header">Marcas e lojas cadastradas</div>
        <div class="table-wrapper">
          <table id="brandsTable">
            <thead>
              <tr>
                <th>Marca</th>
                <th>Código Disagua</th>
                <th>Lojas</th>
                <th class="column-actions">Ações</th>
              </tr>
            </thead>
            <tbody id="brandsTableBody"></tbody>
          </table>
        </div>
        <p id="emptyMessage" class="empty-message">Nenhuma marca cadastrada ainda.</p>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const brandForm = document.getElementById('brandForm');
    const storeForm = document.getElementById('storeForm');
    const brandsTableBody = document.getElementById('brandsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    const marcaSelect = document.getElementById('marca_id');
    const brandSubmitBtn = document.getElementById('brandSubmitBtn');
    const storeSubmitBtn = document.getElementById('storeSubmitBtn');
    const brandMessage = document.getElementById('brandFormMessage');
    const storeMessage = document.getElementById('storeFormMessage');

    let brands = [];
    let stores = [];
    let editingBrandId = null;
    let editingStoreId = null;

    loadData();

    brandForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(brandForm);
      const payload = {
        marca: (formData.get('marca') || '').trim(),
        cod_disagua: (formData.get('cod_disagua') || '').trim(),
      };
      if (!payload.marca) {
        displayMessage(brandMessage, 'Informe o nome da marca.', 'error');
        return;
      }
      if (!payload.cod_disagua) {
        delete payload.cod_disagua;
      }

      const method = editingBrandId ? 'PUT' : 'POST';
      const url = editingBrandId ? `/api/brands/${editingBrandId}` : '/api/brands';

      try {
        brandSubmitBtn.disabled = true;
        brandSubmitBtn.textContent = editingBrandId ? 'Salvando...' : 'Cadastrando...';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível salvar a marca.');
        }
        displayMessage(brandMessage, editingBrandId ? 'Marca atualizada com sucesso.' : 'Marca cadastrada com sucesso.', 'success');
        brandForm.reset();
        editingBrandId = null;
        brandSubmitBtn.textContent = 'Cadastrar marca';
        await loadData();
      } catch (error) {
        displayMessage(brandMessage, error.message, 'error');
      } finally {
        brandSubmitBtn.disabled = false;
      }
    });

    brandForm.addEventListener('reset', () => {
      editingBrandId = null;
      brandSubmitBtn.textContent = 'Cadastrar marca';
      displayMessage(brandMessage, '', '');
    });

    storeForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(storeForm);
      const payload = Object.fromEntries(formData.entries());

      if (!payload.marca_id) {
        displayMessage(storeMessage, 'Selecione uma marca para a loja.', 'error');
        return;
      }

      payload.marca_id = Number(payload.marca_id);
      ['loja', 'cod_disagua', 'local_entrega', 'endereco', 'municipio', 'uf']
        .forEach((field) => {
          if (payload[field] !== undefined && payload[field] !== null) {
            payload[field] = payload[field].trim();
          }
        });
      if (!payload.cod_disagua) {
        delete payload.cod_disagua;
      }
      if (!payload.endereco) {
        payload.endereco = null;
      }
      ['valor_20l', 'valor_10l', 'valor_1500ml', 'valor_cx_copo', 'valor_vasilhame']
        .forEach((field) => {
          const value = payload[field];
          payload[field] = value === '' || value === null ? 0 : Number(value);
        });

      const method = editingStoreId ? 'PUT' : 'POST';
      const url = editingStoreId ? `/api/stores/${editingStoreId}` : '/api/stores';

      try {
        storeSubmitBtn.disabled = true;
        storeSubmitBtn.textContent = editingStoreId ? 'Salvando...' : 'Cadastrando...';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível salvar a loja.');
        }
        displayMessage(storeMessage, editingStoreId ? 'Loja atualizada com sucesso.' : 'Loja cadastrada com sucesso.', 'success');
        storeForm.reset();
        editingStoreId = null;
        storeSubmitBtn.textContent = 'Cadastrar loja';
        await loadData();
      } catch (error) {
        displayMessage(storeMessage, error.message, 'error');
      } finally {
        storeSubmitBtn.disabled = false;
      }
    });

    storeForm.addEventListener('reset', () => {
      editingStoreId = null;
      storeSubmitBtn.textContent = 'Cadastrar loja';
      displayMessage(storeMessage, '', '');
    });

    window.addStoreToBrand = function(brandId) {
      editingStoreId = null;
      storeForm.reset();
      marcaSelect.value = String(brandId);
      storeSubmitBtn.textContent = 'Cadastrar loja';
      displayMessage(storeMessage, 'Preencha os dados da nova loja.', 'success');
      storeForm.scrollIntoView({ behavior: 'smooth' });
    };

    window.editBrand = function(brandId) {
      const brand = brands.find((item) => item.id === brandId);
      if (!brand) {
        return;
      }
      brandForm.marca.value = brand.marca;
      brandForm.cod_disagua.value = brand.cod_disagua || '';
      editingBrandId = brandId;
      brandSubmitBtn.textContent = 'Atualizar marca';
      displayMessage(brandMessage, 'Editando marca. Salve ou limpe o formulário para cancelar.', 'success');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteBrand = async function(brandId) {
      if (!confirm('Tem certeza que deseja excluir esta marca e as lojas associadas?')) {
        return;
      }
      try {
        const response = await fetch(`/api/brands/${brandId}`, { method: 'DELETE' });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível excluir a marca.');
        }
        displayMessage(brandMessage, 'Marca excluída com sucesso.', 'success');
        if (editingBrandId === brandId) {
          brandForm.reset();
          editingBrandId = null;
          brandSubmitBtn.textContent = 'Cadastrar marca';
        }
        await loadData();
      } catch (error) {
        displayMessage(brandMessage, error.message, 'error');
      }
    };

    window.editStore = function(storeId) {
      const store = stores.find((item) => item.id === storeId);
      if (!store) {
        return;
      }
      marcaSelect.value = String(store.marca_id);
      document.getElementById('loja').value = store.loja || '';
      document.getElementById('cod_disagua_loja').value = store.cod_disagua || '';
      document.getElementById('local_entrega').value = store.local_entrega || '';
      document.getElementById('endereco').value = store.endereco || '';
      document.getElementById('municipio').value = store.municipio || '';
      document.getElementById('uf').value = store.uf || '';
      document.getElementById('valor_20l').value = store.valor_20l ?? 0;
      document.getElementById('valor_10l').value = store.valor_10l ?? 0;
      document.getElementById('valor_1500ml').value = store.valor_1500ml ?? 0;
      document.getElementById('valor_cx_copo').value = store.valor_cx_copo ?? 0;
      document.getElementById('valor_vasilhame').value = store.valor_vasilhame ?? 0;
      editingStoreId = storeId;
      storeSubmitBtn.textContent = 'Atualizar loja';
      displayMessage(storeMessage, 'Editando loja. Salve ou limpe o formulário para cancelar.', 'success');
      storeForm.scrollIntoView({ behavior: 'smooth' });
    };

    window.deleteStore = async function(storeId) {
      if (!confirm('Tem certeza que deseja excluir esta loja?')) {
        return;
      }
      try {
        const response = await fetch(`/api/stores/${storeId}`, { method: 'DELETE' });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível excluir a loja.');
        }
        displayMessage(storeMessage, 'Loja excluída com sucesso.', 'success');
        if (editingStoreId === storeId) {
          storeForm.reset();
          editingStoreId = null;
          storeSubmitBtn.textContent = 'Cadastrar loja';
        }
        await loadData();
      } catch (error) {
        displayMessage(storeMessage, error.message, 'error');
      }
    };

    async function loadData() {
      try {
        const [brandsResponse, storesResponse] = await Promise.all([
          fetch('/api/brands'),
          fetch('/api/stores'),
        ]);
        if (!brandsResponse.ok || !storesResponse.ok) {
          throw new Error('Não foi possível carregar as marcas e lojas.');
        }
        brands = await brandsResponse.json();
        stores = await storesResponse.json();
        updateBrandsSelect();
        updateBrandsTable();
      } catch (error) {
        brands = [];
        stores = [];
        updateBrandsSelect();
        updateBrandsTable();
        displayMessage(brandMessage, error.message, 'error');
      }
    }

    function updateBrandsSelect() {
      const currentValue = marcaSelect.value;
      marcaSelect.innerHTML = '<option value="">Selecione uma marca</option>';
      const orderedBrands = [...brands].sort((a, b) => a.marca.localeCompare(b.marca, 'pt-BR'));
      orderedBrands.forEach((brand) => {
        const option = document.createElement('option');
        option.value = brand.id;
        option.textContent = brand.marca;
        marcaSelect.appendChild(option);
      });
      if (currentValue && orderedBrands.some((brand) => String(brand.id) === currentValue)) {
        marcaSelect.value = currentValue;
      }
    }

    function updateBrandsTable() {
      brandsTableBody.innerHTML = '';
      if (!brands.length) {
        emptyMessage.style.display = 'block';
        return;
      }
      emptyMessage.style.display = 'none';

      const currency = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
      const orderedBrands = [...brands].sort((a, b) => a.marca.localeCompare(b.marca, 'pt-BR'));

      orderedBrands.forEach((brand) => {
        const brandStores = stores
          .filter((store) => store.marca_id === brand.id)
          .sort((a, b) => a.loja.localeCompare(b.loja, 'pt-BR'));

        const brandRow = document.createElement('tr');
        brandRow.className = 'brand-header';
        brandRow.dataset.brandId = brand.id;
        brandRow.innerHTML = `
          <td class="brand-name">${brand.marca}</td>
          <td>${brand.cod_disagua || '-'}</td>
          <td>${brandStores.length} loja(s)</td>
          <td class="actions-cell">
            <button type="button" class="btn btn-secondary btn-small" onclick="editBrand(${brand.id})">Editar</button>
            <button type="button" class="btn btn-danger btn-small" onclick="deleteBrand(${brand.id})">Excluir</button>
            <button type="button" class="btn btn-primary btn-small" onclick="addStoreToBrand(${brand.id})">+ Loja</button>
          </td>
        `;
        brandsTableBody.appendChild(brandRow);

        brandRow.addEventListener('click', (event) => {
          if (event.target.tagName === 'BUTTON') {
            return;
          }
          brandRow.classList.toggle('brand-expanded');
        });

        const detailsRow = document.createElement('tr');
        detailsRow.className = 'brand-details';
        if (!brandStores.length) {
          detailsRow.innerHTML = '<td colspan="4" class="text-center text-muted">Nenhuma loja cadastrada para esta marca.</td>';
        } else {
          let storesHTML = '<td colspan="4"><div class="table-wrapper"><table class="table-compact"><thead><tr>' +
            '<th>Loja</th><th>Código</th><th>Local entrega</th><th>Endereço</th><th>Município</th><th>UF</th>' +
            '<th>Valor 20L</th><th>Valor 10L</th><th>Valor 1500ml</th><th>Valor CX copo</th><th>Valor vasilhame</th><th>Ações</th>' +
            '</tr></thead><tbody>';

          brandStores.forEach((store) => {
            storesHTML += `
              <tr>
                <td>${store.loja}</td>
                <td>${store.cod_disagua || '-'}</td>
                <td>${store.local_entrega}</td>
                <td>${store.endereco || '-'}</td>
                <td>${store.municipio}</td>
                <td>${store.uf}</td>
                <td>${currency.format(Number(store.valor_20l) || 0)}</td>
                <td>${currency.format(Number(store.valor_10l) || 0)}</td>
                <td>${currency.format(Number(store.valor_1500ml) || 0)}</td>
                <td>${currency.format(Number(store.valor_cx_copo) || 0)}</td>
                <td>${currency.format(Number(store.valor_vasilhame) || 0)}</td>
                <td class="actions-cell">
                  <button type="button" class="btn btn-secondary btn-small" onclick="editStore(${store.id})">Editar</button>
                  <button type="button" class="btn btn-danger btn-small" onclick="deleteStore(${store.id})">Excluir</button>
                </td>
              </tr>`;
          });

          storesHTML += '</tbody></table></div></td>';
          detailsRow.innerHTML = storesHTML;
        }

        brandsTableBody.appendChild(detailsRow);
      });
    }

    function displayMessage(target, message, type = '') {
      if (!target) {
        return;
      }
      target.textContent = message;
      target.className = type ? `form-message ${type}` : 'form-message';
    }
  });
  </script>
  </main>
</body>
</html>
