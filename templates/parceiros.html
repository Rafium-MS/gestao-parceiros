<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cadastro de Parceiros</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container">
      <header class="section-header">
        <h1>Cadastro de Parceiros</h1>
        <p>Sistema para cadastro e gerenciamento de parceiros comerciais</p>
      </header>

      <div class="form-container">
        <form id="partnerForm">
          <div class="form-section">
            <h2 class="section-title">Informações do Parceiro</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" name="cidade" required>
              </div>
              <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" name="estado" required>
                  <option value="">Selecione</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amapá</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Ceará</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Espírito Santo</option>
                  <option value="GO">Goiás</option>
                  <option value="MA">Maranhão</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Pará</option>
                  <option value="PB">Paraíba</option>
                  <option value="PR">Paraná</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piauí</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rondônia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">São Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
              </div>
              <div class="form-group">
                <label for="parceiro">Parceiro</label>
                <input type="text" id="parceiro" name="parceiro" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="distribuidora">Distribuidora</label>
                <input type="text" id="distribuidora" name="distribuidora">
              </div>
              <div class="form-group">
                <label for="cnpj_cpf">CNPJ/CPF</label>
                <input type="text" id="cnpj_cpf" name="cnpj_cpf" required>
              </div>
              <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="tel" id="telefone" name="telefone" required>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2 class="section-title">Informações Financeiras</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="dia_pagamento">Dia do Pagamento</label>
                <input type="number" id="dia_pagamento" name="dia_pagamento" min="1" max="31">
              </div>
              <div class="form-group">
                <label for="banco">Banco</label>
                <input type="text" id="banco" name="banco">
              </div>
              <div class="form-group">
                <label for="agencia_conta">Agência e Conta</label>
                <input type="text" id="agencia_conta" name="agencia_conta">
              </div>
              <div class="form-group">
                <label for="pix">Chave PIX</label>
                <input type="text" id="pix" name="pix">
              </div>
            </div>
          </div>

          <div class="form-section prices-section">
            <h2 class="section-title">Valores dos Produtos</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="cx_copo">Valor CX Copo</label>
                <input type="number" id="cx_copo" name="cx_copo" min="0" step="0.01" value="0">
              </div>
              <div class="form-group">
                <label for="dez_litros">Valor 10 Litros</label>
                <input type="number" id="dez_litros" name="dez_litros" min="0" step="0.01" value="0">
              </div>
              <div class="form-group">
                <label for="vinte_litros">Valor 20 Litros</label>
                <input type="number" id="vinte_litros" name="vinte_litros" min="0" step="0.01" value="0">
              </div>
              <div class="form-group">
                <label for="mil_quinhentos_ml">Valor 1500 ml</label>
                <input type="number" id="mil_quinhentos_ml" name="mil_quinhentos_ml" min="0" step="0.01" value="0">
              </div>
              <div class="form-group">
                <label for="vasilhame">Valor Vasilhame</label>
                <input type="number" id="vasilhame" name="vasilhame" min="0" step="0.01" value="0">
              </div>
            </div>
            <div class="total-display">
              Total estimado: <span id="total-prices">0</span>
            </div>
          </div>

          <div class="btn-container">
            <button type="submit" class="btn btn-success" id="partnerSubmitBtn">Cadastrar Parceiro</button>
            <button type="reset" class="btn btn-danger">Limpar formulário</button>
          </div>
          <div id="partnerMessage" class="form-message" role="status" aria-live="polite"></div>
        </form>
      </div>

      <div class="partners-list">
        <div class="list-header">Parceiros cadastrados</div>
        <div class="table-wrapper">
          <table id="partnersTable">
            <thead>
              <tr>
                <th>Cidade</th>
                <th>Estado</th>
                <th>Parceiro</th>
                <th>Distribuidora</th>
                <th>CNPJ/CPF</th>
                <th>Telefone</th>
                <th>Email</th>
                <th>Total</th>
                <th class="column-actions">Ações</th>
              </tr>
            </thead>
            <tbody id="partnersTableBody"></tbody>
          </table>
        </div>
        <p id="emptyMessage" class="empty-message">Nenhum parceiro cadastrado ainda.</p>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('partnerForm');
    const partnersTableBody = document.getElementById('partnersTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    const totalDisplay = document.getElementById('total-prices');
    const priceInputs = form.querySelectorAll('.prices-section input[type="number"]');
    const submitBtn = document.getElementById('partnerSubmitBtn');
    const messageBox = document.getElementById('partnerMessage');

    let partners = [];
    let editingPartnerId = null;

    loadPartners();
    updateTotal();

    priceInputs.forEach((input) => input.addEventListener('input', updateTotal));

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = buildPayload(new FormData(form));
      const method = editingPartnerId ? 'PUT' : 'POST';
      const url = editingPartnerId ? `/api/partners/${editingPartnerId}` : '/api/partners';

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = editingPartnerId ? 'Salvando alterações...' : 'Cadastrando...';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível salvar o parceiro.');
        }
        displayMessage(editingPartnerId ? 'Parceiro atualizado com sucesso.' : 'Parceiro cadastrado com sucesso.', 'success');
        form.reset();
        editingPartnerId = null;
        submitBtn.textContent = 'Cadastrar Parceiro';
        await loadPartners();
      } catch (error) {
        displayMessage(error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        updateTotal();
      }
    });

    form.addEventListener('reset', () => {
      editingPartnerId = null;
      submitBtn.textContent = 'Cadastrar Parceiro';
      messageBox.textContent = '';
      messageBox.className = 'form-message';
      setTimeout(updateTotal, 0);
    });

    partnersTableBody.addEventListener('click', (event) => {
      const editBtn = event.target.closest('.btn-edit-partner');
      if (editBtn) {
        const partnerId = Number.parseInt(editBtn.dataset.id, 10);
        const partner = partners.find((item) => item.id === partnerId);
        if (partner) {
          startEdit(partner);
        }
        return;
      }

      const deleteBtn = event.target.closest('.btn-delete-partner');
      if (deleteBtn) {
        const partnerId = Number.parseInt(deleteBtn.dataset.id, 10);
        if (!Number.isNaN(partnerId)) {
          deletePartner(partnerId);
        }
      }
    });

    async function loadPartners() {
      try {
        const response = await fetch('/api/partners');
        if (!response.ok) {
          throw new Error('Não foi possível carregar os parceiros.');
        }
        partners = await response.json();
        renderPartners();
      } catch (error) {
        partners = [];
        renderPartners();
        displayMessage(error.message, 'error');
      }
    }

    function renderPartners() {
      partnersTableBody.innerHTML = '';
      if (!partners.length) {
        emptyMessage.style.display = 'block';
        return;
      }
      emptyMessage.style.display = 'none';

      const currency = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
      partners.forEach((partner) => {
        const row = document.createElement('tr');
        const total = typeof partner.total === 'number'
          ? partner.total
          : ['cx_copo', 'dez_litros', 'vinte_litros', 'mil_quinhentos_ml', 'vasilhame']
              .reduce((acc, field) => acc + (Number(partner[field]) || 0), 0);
        row.innerHTML = `
          <td>${partner.cidade}</td>
          <td>${partner.estado}</td>
          <td>${partner.parceiro}</td>
          <td>${partner.distribuidora || '-'}</td>
          <td>${partner.cnpj_cpf}</td>
          <td>${partner.telefone}</td>
          <td>${partner.email || '-'}</td>
          <td>${currency.format(total || 0)}</td>
          <td class="actions-cell">
            <button type="button" class="btn btn-secondary btn-small btn-edit-partner" data-id="${partner.id}">Editar</button>
            <button type="button" class="btn btn-danger btn-small btn-delete-partner" data-id="${partner.id}">Excluir</button>
          </td>
        `;
        partnersTableBody.appendChild(row);
      });
    }

    function buildPayload(formData) {
      const payload = Object.fromEntries(formData.entries());
      ['cidade', 'estado', 'parceiro', 'distribuidora', 'cnpj_cpf', 'telefone', 'email', 'banco', 'agencia_conta', 'pix']
        .forEach((field) => {
          if (payload[field] !== undefined && payload[field] !== null) {
            payload[field] = payload[field].trim();
            if (payload[field] === '') {
              payload[field] = null;
            }
          }
        });
      payload.dia_pagamento = payload.dia_pagamento ? Number(payload.dia_pagamento) : null;
      ['cx_copo', 'dez_litros', 'vinte_litros', 'mil_quinhentos_ml', 'vasilhame']
        .forEach((field) => {
          const value = payload[field];
          payload[field] = value === null || value === '' ? 0 : Number(value);
        });
      return payload;
    }

    function updateTotal() {
      const total = Array.from(priceInputs)
        .reduce((acc, input) => acc + (parseFloat(input.value) || 0), 0);
      totalDisplay.textContent = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
    }

    function displayMessage(message, type = 'success') {
      messageBox.textContent = message;
      messageBox.className = type ? `form-message ${type}` : 'form-message';
    }

    function startEdit(partner) {
      editingPartnerId = partner.id;
      form.cidade.value = partner.cidade || '';
      form.estado.value = partner.estado || '';
      form.parceiro.value = partner.parceiro || '';
      form.distribuidora.value = partner.distribuidora || '';
      form.cnpj_cpf.value = partner.cnpj_cpf || '';
      form.telefone.value = partner.telefone || '';
      form.email.value = partner.email || '';
      form.dia_pagamento.value = partner.dia_pagamento ?? '';
      form.banco.value = partner.banco || '';
      form.agencia_conta.value = partner.agencia_conta || '';
      form.pix.value = partner.pix || '';
      form.cx_copo.value = partner.cx_copo ?? 0;
      form.dez_litros.value = partner.dez_litros ?? 0;
      form.vinte_litros.value = partner.vinte_litros ?? 0;
      form.mil_quinhentos_ml.value = partner.mil_quinhentos_ml ?? 0;
      form.vasilhame.value = partner.vasilhame ?? 0;
      submitBtn.textContent = 'Atualizar Parceiro';
      displayMessage('Você está editando um parceiro. Salve ou limpe o formulário para cancelar.', 'success');
      updateTotal();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deletePartner(partnerId) {
      if (!confirm('Deseja realmente excluir este parceiro?')) {
        return;
      }
      try {
        const response = await fetch(`/api/partners/${partnerId}`, { method: 'DELETE' });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Não foi possível excluir o parceiro.');
        }
        displayMessage('Parceiro removido com sucesso.', 'success');
        if (editingPartnerId === partnerId) {
          form.reset();
          editingPartnerId = null;
          submitBtn.textContent = 'Cadastrar Parceiro';
        }
        await loadPartners();
      } catch (error) {
        displayMessage(error.message, 'error');
      }
    }
  });
  </script>
  </main>
</body>
</html>
