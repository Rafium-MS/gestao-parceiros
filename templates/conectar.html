<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conexão Parceiro-Loja</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include '_nav.html' %}
  <main class="page-content">
    <div class="container container-wide">
      <header class="section-header">
        <h1>Conexão Parceiro-Loja</h1>
        <p>Sistema para conectar parceiros às lojas com base na localização</p>
      </header>

      <div class="filters-container">
        <h2 class="section-title">Filtros de localização</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option value="">Todos os estados</option>
              <option value="AC">Acre</option>
              <option value="AL">Alagoas</option>
              <option value="AP">Amapá</option>
              <option value="AM">Amazonas</option>
              <option value="BA">Bahia</option>
              <option value="CE">Ceará</option>
              <option value="DF">Distrito Federal</option>
              <option value="ES">Espírito Santo</option>
              <option value="GO">Goiás</option>
              <option value="MA">Maranhão</option>
              <option value="MT">Mato Grosso</option>
              <option value="MS">Mato Grosso do Sul</option>
              <option value="MG">Minas Gerais</option>
              <option value="PA">Pará</option>
              <option value="PB">Paraíba</option>
              <option value="PR">Paraná</option>
              <option value="PE">Pernambuco</option>
              <option value="PI">Piauí</option>
              <option value="RJ">Rio de Janeiro</option>
              <option value="RN">Rio Grande do Norte</option>
              <option value="RS">Rio Grande do Sul</option>
              <option value="RO">Rondônia</option>
              <option value="RR">Roraima</option>
              <option value="SC">Santa Catarina</option>
              <option value="SP">São Paulo</option>
              <option value="SE">Sergipe</option>
              <option value="TO">Tocantins</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" placeholder="Digite o nome da cidade">
          </div>
        </div>
        <div class="btn-container">
          <button id="searchBtn" class="btn btn-primary">Buscar conexões</button>
          <button id="resetBtn" class="btn btn-danger">Limpar filtros</button>
        </div>
      </div>

      <div class="results-container">
        <div class="card">
          <div class="card-header">Parceiros disponíveis</div>
          <div class="card-body" id="partnersList"></div>
        </div>
        <div class="card">
          <div class="card-header">Lojas disponíveis</div>
          <div class="card-body" id="storesList"></div>
        </div>
        <div class="card">
          <div class="card-header">Conexões ativas</div>
          <div class="card-body" id="connectionsList"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const estadoSelect = document.getElementById('estado');
    const cidadeInput = document.getElementById('cidade');
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const partnersList = document.getElementById('partnersList');
    const storesList = document.getElementById('storesList');
    const connectionsList = document.getElementById('connectionsList');

    let partners = JSON.parse(localStorage.getItem('partners')) || [];
    let brands = JSON.parse(localStorage.getItem('brands')) || [];
    let stores = JSON.parse(localStorage.getItem('stores')) || [];
    let connections = JSON.parse(localStorage.getItem('connections')) || [];

    updatePartnersList();
    updateStoresList();
    updateConnectionsList();

    searchBtn.addEventListener('click', function() {
      updatePartnersList();
      updateStoresList();
      updateConnectionsList();
    });

    resetBtn.addEventListener('click', function() {
      estadoSelect.value = '';
      cidadeInput.value = '';
      updatePartnersList();
      updateStoresList();
      updateConnectionsList();
    });

    function updatePartnersList() {
      partnersList.innerHTML = '';
      const estado = estadoSelect.value;
      const cidade = cidadeInput.value.toLowerCase();
      const filteredPartners = partners.filter(partner => {
        let matchEstado = true;
        let matchCidade = true;
        if (estado) {
          matchEstado = partner.estado === estado;
        }
        if (cidade) {
          matchCidade = partner.cidade.toLowerCase().includes(cidade);
        }
        return matchEstado && matchCidade;
      });

      if (filteredPartners.length === 0) {
        partnersList.innerHTML = '<div class="empty-message">Nenhum parceiro encontrado com os filtros aplicados.</div>';
        return;
      }

      filteredPartners.forEach((partner, index) => {
        const partnerItem = document.createElement('div');
        partnerItem.className = 'connection-item';
        partnerItem.innerHTML = `
          <div class="connection-info">
            <strong>${partner.parceiro}</strong><br>
            ${partner.cidade} - ${partner.estado}<br>
            <small>${partner.distribuidora || 'Sem distribuidora'}</small>
          </div>
          <div class="connection-actions">
            <button class="btn btn-primary btn-small" onclick="connectPartner(${index})">Conectar</button>
          </div>`;
        partnersList.appendChild(partnerItem);
      });
    }

    function updateStoresList() {
      storesList.innerHTML = '';
      const estado = estadoSelect.value;
      const cidade = cidadeInput.value.toLowerCase();
      const filteredStores = stores.filter(store => {
        let matchEstado = true;
        let matchCidade = true;
        if (estado) {
          matchEstado = store.uf === estado;
        }
        if (cidade) {
          matchCidade = store.municipio.toLowerCase().includes(cidade);
        }
        return matchEstado && matchCidade;
      });

      if (filteredStores.length === 0) {
        storesList.innerHTML = '<div class="empty-message">Nenhuma loja encontrada com os filtros aplicados.</div>';
        return;
      }

      filteredStores.forEach((store, index) => {
        const brand = brands[store.marca_id];
        const storeItem = document.createElement('div');
        storeItem.className = 'connection-item';
        storeItem.innerHTML = `
          <div class="connection-info">
            <strong>${store.loja}</strong><br>
            ${store.municipio} - ${store.uf}<br>
            <small>Marca: ${(brand && brand.marca) || 'N/D'}</small>
          </div>
          <div class="connection-actions">
            <button class="btn btn-primary btn-small" onclick="connectStore(${index})">Conectar</button>
          </div>`;
        storesList.appendChild(storeItem);
      });
    }

    function updateConnectionsList() {
      connectionsList.innerHTML = '';
      if (connections.length === 0) {
        connectionsList.innerHTML = '<div class="empty-message">Nenhuma conexão ativa.</div>';
        return;
      }

      connections.forEach((connection, index) => {
        const partner = partners[connection.partnerIndex];
        const store = stores[connection.storeIndex];
        if (!partner || !store) return;
        const connectionItem = document.createElement('div');
        connectionItem.className = 'connection-item';
        connectionItem.innerHTML = `
          <div class="connection-info">
            <strong>${partner.parceiro}</strong> &rarr; <strong>${store.loja}</strong><br>
            <span class="status-connected">Conectado</span>
          </div>
          <div class="connection-actions">
            <button class="btn btn-danger btn-small" onclick="disconnect(${index})">Desconectar</button>
          </div>`;
        connectionsList.appendChild(connectionItem);
      });
    }

    window.connectPartner = function(partnerIndex) {
      const availableStore = stores.findIndex(store => {
        return !connections.some(conn => conn.storeIndex === stores.indexOf(store)) &&
               (!estadoSelect.value || store.uf === estadoSelect.value);
      });
      if (availableStore === -1) {
        alert('Nenhuma loja disponível para conexão.');
        return;
      }
      connections.push({ partnerIndex, storeIndex: availableStore });
      localStorage.setItem('connections', JSON.stringify(connections));
      updateConnectionsList();
      alert('Conexão criada com sucesso!');
    };

    window.connectStore = function(storeIndex) {
      const availablePartner = partners.findIndex(partner => {
        return !connections.some(conn => conn.partnerIndex === partners.indexOf(partner)) &&
               (!estadoSelect.value || partner.estado === estadoSelect.value);
      });
      if (availablePartner === -1) {
        alert('Nenhum parceiro disponível para conexão.');
        return;
      }
      connections.push({ partnerIndex: availablePartner, storeIndex });
      localStorage.setItem('connections', JSON.stringify(connections));
      updateConnectionsList();
      alert('Conexão criada com sucesso!');
    };

    window.disconnect = function(index) {
      connections.splice(index, 1);
      localStorage.setItem('connections', JSON.stringify(connections));
      updateConnectionsList();
      alert('Conexão removida.');
    };
  });
  </script>
  </main>
</body>
</html>
