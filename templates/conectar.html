<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Parceiro-Loja</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .filters-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1 0 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1 0 300px;
        }

        .card-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .card-body {
            padding: 15px;
        }

        .connection-item {
            padding: 10px;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-item:last-child {
            border-bottom: none;
        }

        .connection-info {
            flex: 1;
        }

        .connection-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .empty-message {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .status-connected {
            color: #2ecc71;
            font-weight: 600;
        }

        .status-disconnected {
            color: #e74c3c;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .form-group {
                flex: 1 0 100%;
            }
            
            .card {
                flex: 1 0 100%;
            }
        }
    </style>
</head>
<body>
<nav>
  <a href="/">Início</a>
  <a href="/parceiros">Parceiros</a>
  <a href="/lojas">Lojas</a>
  <a href="/conectar">Conectar</a>
  <a href="/comprovantes">Comprovantes</a>
  <a href="/relatorios">Relatórios</a>
</nav>
    <div class="container">
        <header>
            <h1>Conexão Parceiro-Loja</h1>
            <p>Sistema para conectar parceiros às lojas com base na localização</p>
        </header>

        <div class="filters-container">
            <h2>Filtros de Localização</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="estado">ESTADO</label>
                    <select id="estado" name="estado">
                        <option value="">Todos os estados</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AP">Amapá</option>
                        <option value="AM">Amazonas</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Ceará</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Espírito Santo</option>
                        <option value="GO">Goiás</option>
                        <option value="MA">Maranhão</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="PA">Pará</option>
                        <option value="PB">Paraíba</option>
                        <option value="PR">Paraná</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piauí</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rondônia</option>
                        <option value="RR">Roraima</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SP">São Paulo</option>
                        <option value="SE">Sergipe</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cidade">CIDADE</label>
                    <input type="text" id="cidade" name="cidade" placeholder="Digite o nome da cidade">
                </div>
            </div>
            <div class="btn-container">
                <button id="searchBtn" class="btn-primary">Buscar Conexões</button>
                <button id="resetBtn" class="btn-danger">Limpar Filtros</button>
            </div>
        </div>

        <div class="results-container">
            <div class="card">
                <div class="card-header">
                    Parceiros Disponíveis
                </div>
                <div class="card-body" id="partnersList">
                    <!-- Lista de parceiros será preenchida via JavaScript -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Lojas Disponíveis
                </div>
                <div class="card-body" id="storesList">
                    <!-- Lista de lojas será preenchida via JavaScript -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Conexões Ativas
                </div>
                <div class="card-body" id="connectionsList">
                    <!-- Lista de conexões será preenchida via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>

document.addEventListener('DOMContentLoaded', function() {
    const estadoSelect = document.getElementById('estado');
    const cidadeInput = document.getElementById('cidade');
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const partnersList = document.getElementById('partnersList');
    const storesList = document.getElementById('storesList');
    const connectionsList = document.getElementById('connectionsList');

    let partners = [];
    let brands = [];
    let stores = [];
    let connections = [];

    async function loadAll(){
        partners = await (await fetch('/api/partners')).json();
        brands = await (await fetch('/api/brands')).json();
        stores = await (await fetch('/api/stores')).json();
        connections = await (await fetch('/api/connections')).json();
        updatePartnersList();
        updateStoresList();
        updateConnectionsList();
    }

    searchBtn.addEventListener('click', function() {
        updatePartnersList();
        updateStoresList();
        updateConnectionsList();
    });

    resetBtn.addEventListener('click', function() {
        estadoSelect.value='';
        cidadeInput.value='';
        updatePartnersList();
        updateStoresList();
        updateConnectionsList();
    });

    function filterByLocale(list, getState, getCity){
        const uf = estadoSelect.value;
        const city = (cidadeInput.value||'').toLowerCase();
        return list.filter(item => {
            let okUF = !uf || getState(item) === uf;
            let okCity = !city || (getCity(item)||'').toLowerCase().includes(city);
            return okUF && okCity;
        });
    }

    function updatePartnersList(){
        partnersList.innerHTML='';
        const filtered = filterByLocale(partners, p=>p.estado, p=>p.cidade);
        if(filtered.length===0){ partnersList.innerHTML='<div class="empty-message">Nenhum parceiro encontrado.</div>'; return; }
        filtered.forEach(p => {
            const div = document.createElement('div');
            div.className='connection-item';
            div.innerHTML = `
                <div class="connection-info">
                    <strong>${p.parceiro}</strong><br>
                    ${p.cidade} - ${p.estado}<br>
                    <small>${p.distribuidora || 'Sem distribuidora'}</small>
                </div>
                <div class="connection-actions">
                    <button class="btn-primary btn-small" data-partner="${p.id}">Conectar</button>
                </div>`;
            div.querySelector('button').addEventListener('click', ()=>connectFromPartner(p.id));
            partnersList.appendChild(div);
        });
    }

    function updateStoresList(){
        storesList.innerHTML='';
        const filtered = filterByLocale(stores, s=>s.uf, s=>s.municipio);
        if(filtered.length===0){ storesList.innerHTML='<div class="empty-message">Nenhuma loja encontrada.</div>'; return; }
        filtered.forEach(s => {
            const b = brands.find(x=>x.id===s.marca_id);
            const div = document.createElement('div');
            div.className='connection-item';
            div.innerHTML = `
                <div class="connection-info">
                    <strong>${s.loja}</strong><br>
                    ${(b&&b.marca) || 'Marca' }<br>
                    ${s.municipio} - ${s.uf}<br>
                    <small>${s.local_entrega||''}</small>
                </div>
                <div class="connection-actions">
                    <button class="btn-primary btn-small" data-store="${s.id}">Conectar</button>
                </div>`;
            div.querySelector('button').addEventListener('click', ()=>connectFromStore(s.id));
            storesList.appendChild(div);
        });
    }

    function updateConnectionsList(){
        connectionsList.innerHTML='';
        if(!connections || connections.length===0){
            connectionsList.innerHTML='<div class="empty-message">Nenhuma conexão ativa.</div>'; return;
        }
        connections.forEach(c => {
            const p = partners.find(x=>x.id===c.partner_id);
            const s = stores.find(x=>x.id===c.store_id);
            const b = s ? brands.find(x=>x.id===s.marca_id) : null;
            const div = document.createElement('div');
            div.className='connection-item';
            div.innerHTML = `
                <div class="connection-info">
                    <strong>${p ? p.parceiro : 'Parceiro'}</strong> ↔ <strong>${s ? s.loja : 'Loja'}</strong><br>
                    ${p ? (p.cidade+' - '+p.estado) : ''} → ${s ? (s.municipio+' - '+s.uf) : ''}<br>
                    <small>${b ? b.marca : ''}</small><br>
                    <span class="status-connected">CONECTADO</span>
                </div>`;
            connectionsList.appendChild(div);
        });
    }

    async function connectFromPartner(partnerId){
        // Match candidate stores at same city/UF
        const p = partners.find(x=>x.id===partnerId);
        const options = stores.filter(s => s.uf===p.estado && (s.municipio||'').toLowerCase() === (p.cidade||'').toLowerCase());
        if (options.length===0){ alert(`Sem lojas em ${p.cidade}-${p.estado}`); return; }
        const choice = prompt(`Selecione a loja:

${options.map((s,i)=>`${i+1}. ${s.loja}`).join('
')}

Digite o número:`);
        if (choice===null) return;
        const idx = parseInt(choice)-1;
        if (idx<0 || idx>=options.length){ alert('Opção inválida'); return; }
        const storeId = options[idx].id;
        const res = await fetch('/api/connections', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({partner_id: partnerId, store_id: storeId}) });
        if(!res.ok){ alert('Conexão já existe ou erro.'); return; }
        connections = await (await fetch('/api/connections')).json();
        updateConnectionsList();
        alert('Conexão criada!');
    }

    async function connectFromStore(storeId){
        const s = stores.find(x=>x.id===storeId);
        const options = partners.filter(p => p.estado===s.uf && (p.cidade||'').toLowerCase() === (s.municipio||'').toLowerCase());
        if (options.length===0){ alert(`Sem parceiros em ${s.municipio}-${s.uf}`); return; }
        const choice = prompt(`Selecione o parceiro:

${options.map((p,i)=>`${i+1}. ${p.parceiro}`).join('
')}

Digite o número:`);
        if (choice===null) return;
        const idx = parseInt(choice)-1;
        if (idx<0 || idx>=options.length){ alert('Opção inválida'); return; }
        const partnerId = options[idx].id;
        const res = await fetch('/api/connections', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({partner_id: partnerId, store_id: storeId}) });
        if(!res.ok){ alert('Conexão já existe ou erro.'); return; }
        connections = await (await fetch('/api/connections')).json();
        updateConnectionsList();
        alert('Conexão criada!');
    }

    loadAll();
});

</script>
</body>
</html>